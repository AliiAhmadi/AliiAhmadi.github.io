<!doctype html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><title>avatar.png</title><meta content="Ali Ahmadi" name=author><meta content="Dynamically generating PNGs with your IP address in them." name=description><meta content=AliAhmadi2004.ir property=og:site_name><meta content=en-us property=og:locale><meta content=https://AliAhmadi2004.ir/posts/avatar-png/ property=og:url><meta content=avatar.png property=og:title><meta content="Dynamically generating PNGs with your IP address in them." property=og:description><meta content=article property=og:type><meta content="Ali Ahmadi" property=og:article:author><meta content=2023-12-31T04:56:00-08:00 property=og:article:published_time><meta content=Posts property=og:article:section><meta content=Rust property=og:article:tag><meta content=PHP property=og:article:tag><meta content=Networking property=og:article:tag><meta content=webdev property=og:article:tag><meta content=PNG property=og:article:tag><link href=https://fonts.googleapis.com/ rel=dns-prefetch><link href=/site.css rel=stylesheet><link rel="shortcut icon" href=/favicon.svg type=image/svg+xml><link href=https://AliAhmadi2004.ir/posts/avatar-png/ rel=canonical><body><div class=center><img alt=Me src=/self.jpg width=100></div><main><article id=content><header><h1>avatar.png</h1><div class=post-meta><time datetime=2023-12-31T04:56:00-08:00>2023-12-31</time><span class=accent> ⬡ </span><a href=https://AliAhmadi2004.ir/tags/rust/>#Rust</a>, <a href=https://AliAhmadi2004.ir/tags/php/>#PHP</a>, <a href=https://AliAhmadi2004.ir/tags/networking/>#Networking</a>, <a href=https://AliAhmadi2004.ir/tags/webdev/>#webdev</a>, <a href=https://AliAhmadi2004.ir/tags/png/>#PNG</a></div></header><p>No, not that Avatar. And not the other one either. This post is about <code>avatar.png</code>, a handful of lines of PHP that have inspired me for a long time.<p>Around 2011 or 2012 a friend of mine, <a href=https://andrew.kvalhe.im/>Andrew Kvalheim</a>, blew my mind when he made his Skype profile picture display the IP address of the computer I was using. It might have looked a bit like this.</p><span id=continue-reading></span><div style=display:flex;align-items:center;justify-content:center><img alt="White text on
a pinkish/purple background which says 'Hello, 140.160.254.56!'." src=avatar.png style=height:256px;width:256px></div><p>We were both working at our university's IT help desk and I think Skype for Business had just been rolled out to employees. If memory serves the application let you upload a profile picture or give a URL for one. The image was always fetched by the client, which made it possible to display a different image to each person viewing your profile picture.<p>For me this was practically magic. I was fairly early in my programming education at that point, so it took me a long time to really understand what was going on.<p>The web server was serving a file named <code>avatar.png</code>. When viewed in a browser you got a PNG containing your IP address, but when you opened the file itself in a text editor it was PHP! How could one file be two different things depending on how you looked at it?<p>I later learned that file extensions are mostly a suggestion and that with enough creativity you can make computers to do a lot of fun things. That file <em>can</em> be two things at once, it just depends on your point of view.<p>Reflecting on the inspiration I've gotten from this simple program, I've spent a bit of time translating <code>avatar.png</code> from PHP to Rust. I learned way more than I bargained for in the process. Hopefully you'll learn something too as you read this.<h1 id=php><a aria-label="Anchor link for: php" href=#php></a>PHP</h1><p>Here is the original PHP which generated <code>avatar.png</code>. Judging by when this was written I think it probably would have run on PHP 5.3 or 5.4.<pre class=language-php data-lang=php style=background:#282828;color:#fdf4c1aa><code class=language-php data-lang=php><span>&LT?php
</span><span style=color:#fdf4c1>
</span><span style=color:#fdf4c1>    </span><span style=font-style:italic;color:#928374>//Get IP address
</span><span style=color:#fdf4c1>    $ip </span><span style=color:#fe8019>= </span><span style=color:#fabd2f>explode</span><span style=color:#fdf4c1>(</span><span style=color:#b8bb26>'.'</span><span style=color:#fdf4c1>, $_SERVER[</span><span style=color:#b8bb26>'REMOTE_ADDR'</span><span style=color:#fdf4c1>], </span><span style=color:#d3869b>4</span><span style=color:#fdf4c1>);
</span><span style=color:#fdf4c1>
</span><span style=color:#fdf4c1>    </span><span style=font-style:italic;color:#928374>//Render image
</span><span style=color:#fdf4c1>    $image </span><span style=color:#fe8019>= @</span><span style=color:#fabd2f>imagecreate</span><span style=color:#fdf4c1>(</span><span style=color:#d3869b>256</span><span style=color:#fdf4c1>, </span><span style=color:#d3869b>256</span><span style=color:#fdf4c1>)
</span><span style=color:#fdf4c1>        </span><span style=color:#fe8019>or </span><span style=color:#fa5c4b>die</span><span style=color:#fdf4c1>(</span><span style=color:#b8bb26>"Cannot Initialize new GD image stream"</span><span style=color:#fdf4c1>);
</span><span style=color:#fdf4c1>    $background_color </span><span style=color:#fe8019>= </span><span style=color:#fabd2f>imagecolorallocate</span><span style=color:#fdf4c1>($image, </span><span style=color:#d3869b>119</span><span style=color:#fdf4c1>, </span><span style=color:#d3869b>41</span><span style=color:#fdf4c1>, </span><span style=color:#d3869b>83</span><span style=color:#fdf4c1>);
</span><span style=color:#fdf4c1>    $text_color </span><span style=color:#fe8019>= </span><span style=color:#fabd2f>imagecolorallocate</span><span style=color:#fdf4c1>($image, </span><span style=color:#d3869b>255</span><span style=color:#fdf4c1>, </span><span style=color:#d3869b>255</span><span style=color:#fdf4c1>, </span><span style=color:#d3869b>255</span><span style=color:#fdf4c1>);
</span><span style=color:#fdf4c1>    </span><span style=color:#fabd2f>imagettftext</span><span style=color:#fdf4c1>($image, </span><span style=color:#d3869b>24</span><span style=color:#fdf4c1>, </span><span style=color:#d3869b>0</span><span style=color:#fdf4c1>, </span><span style=color:#d3869b>8</span><span style=color:#fdf4c1>, </span><span style=color:#d3869b>96</span><span style=color:#fdf4c1>, $text_color, </span><span style=color:#b8bb26>'UbuntuMono-Regular.ttf'</span><span style=color:#fdf4c1>, </span><span style=color:#b8bb26>"Hello, \n</span><span style=color:#fdf4c1>$ip</span><span style=color:#b8bb26>[</span><span style=color:#d3869b>0</span><span style=color:#b8bb26>].</span><span style=color:#fdf4c1>$ip</span><span style=color:#b8bb26>[</span><span style=color:#d3869b>1</span><span style=color:#b8bb26>].</span><span style=color:#fdf4c1>$ip</span><span style=color:#b8bb26>[</span><span style=color:#d3869b>2</span><span style=color:#b8bb26>].</span><span style=color:#fdf4c1>$ip</span><span style=color:#b8bb26>[</span><span style=color:#d3869b>3</span><span style=color:#b8bb26>]!"</span><span style=color:#fdf4c1>);
</span><span style=color:#fdf4c1>
</span><span style=color:#fdf4c1>    </span><span style=font-style:italic;color:#928374>//Send response
</span><span style=color:#fdf4c1>    </span><span style=color:#fabd2f>header</span><span style=color:#fdf4c1>(</span><span style=color:#b8bb26>'Content-Type: image/png'</span><span style=color:#fdf4c1>);
</span><span style=color:#fdf4c1>    </span><span style=color:#fabd2f>imagepng</span><span style=color:#fdf4c1>($image);
</span><span style=color:#fdf4c1>    </span><span style=color:#fabd2f>imagedestroy</span><span style=color:#fdf4c1>($image);
</span><span>?>
</span></code></pre><p>In case you're not overly familiar with PHP, here's a quick rundown on what's happening there.<ul><li><p><a href=https://www.php.net/manual/en/reserved.variables.server.php><code>$_SERVER</code></a> — An array containing a bunch of information about the server and its environment. The <code>REMOTE_ADDR</code> element has</p> <blockquote><p>The IP address from which the user is viewing the current page.</blockquote><li><p><a href=https://www.php.net/manual/en/function.explode.php><code>explode</code></a> — Splits a string up by some separator. I can't find official docs, but Reddit has some <a href=https://www.reddit.com/r/lolphp/comments/mdkvzl/comment/gsafb5u/>thoughts</a> about the odd name.</p><li><p><a href=https://www.php.net/manual/en/function.imagecreate.php><code>imagecreate</code></a> — Part of the <a href=https://www.php.net/manual/en/intro.image.php>"Graphics Draw"</a> library. Creates a new <a href=https://www.php.net/manual/en/class.gdimage.php><code>GdImage</code></a> object. The <a href=https://www.php.net/manual/en/language.operators.errorcontrol.php><code>@</code></a> sigil in front of this call is for error suppression.</p><li><p><a href=https://www.php.net/manual/en/function.die.php><code>die</code></a> — PHP refuses to have normal names. Equivalent to <a href=https://www.php.net/manual/en/function.exit.php><code>exit</code></a>, which I think exits the whole process. Docs discussion leads me to believe this is disastrous for the client.</p><li><p><a href=https://www.php.net/manual/en/function.imagecolorallocate.php><code>imagecolorallocate</code></a> — Allocate an RGB color for an image. What it means to "allocate" a color is never clarified, but the docs do say</p> <blockquote><p>The first call to <code>imagecolorallocate()</code> fills the background color...</blockquote><li><p><a href=https://www.php.net/manual/en/function.imagettftext.php><code>imagettftext</code></a> — Write text to the image using <a href=https://en.wikipedia.org/wiki/TrueType>TrueType</a> fonts. Interestingly this appears to read the <code>.ttf</code> file from disk on every single request. 😬</p><li><p><a href=https://www.php.net/manual/en/function.header.php><code>header</code></a> — Send a raw <a href=https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers>HTTP header</a>. Importantly, this</p> <blockquote><p>... must be called before any actual output is sent ...</blockquote> <p>So, don't mess up that order!</p><li><p><a href=https://www.php.net/manual/en/function.imagepng.php><code>imagepng</code></a> — Output a PNG image. Returns <code>true</code> on success and <code>false</code> otherwise. Somehow magically streams the image to the client in between.</p><li><p><a href=https://www.php.net/manual/en/function.imagedestroy.php><code>imagedestroy</code></a> — This used to free any memory associated with the <code>GdImage</code> object, but these days it doesn't do anything at all.</p></ul><p>I want to note that while reading the PHP docs I discovered that a significant amount of this code overlaps with the <a href=https://www.php.net/manual/en/function.imagecreate.php#refsect1-function.imagecreate-examples>first <code>imagecreate</code> example</a>. I think this showcases the benefits of quickly copying what you need and adapting it to your purposes. As we become more experienced software engineers we often over-engineer the heck out of things (that's half of what this post is about). But there's real joy in just grabbing what you find and using it as-is, especially for low-stakes fun.<h1 id=rust><a aria-label="Anchor link for: rust" href=#rust></a>Rust</h1><p><code>Ok</code>. Now that we understand the PHP well enough to translate it, let's set some ground rules.<ol><li><p>I like it when blog posts build up solutions, showing mistakes and oddities on the way. If you want to skip all that, here's <a href=https://AliAhmadi2004.ir/posts/avatar-png/#the-finished-product>the finished product</a>.</p><li><p>I assume a basic level of Rust understanding. I don't expect you to have read <a href=https://doc.rust-lang.org/book/>The Book</a> cover to cover, but I'll skip over many explanations.</p><li><p>As I translate this, keep in mind that PHP is a language made for the web. I'm not competing for brevity and certainly not trying to play <a href=https://en.wikipedia.org/wiki/Code_golf>code golf</a>. The Rust code <strong>WILL</strong> be longer.</p><li><p>I'll cut some corners in the initial implementation for the sake of understanding, but try to tidy things up by the end.</p></ol><h2 id=choosing-a-framework><a aria-label="Anchor link for: choosing-a-framework" href=#choosing-a-framework></a>Choosing A Framework</h2><p>The original PHP was likely run in <a href=https://httpd.apache.org/>Apache</a> using <a href=https://cwiki.apache.org/confluence/display/httpd/PHP#PHP-Usingmod_phpasaDSO(legacy)>mod_php</a>, which appears to be out of style these days. In Rust we don't necessarily run a separate server like Apache or <a href=https://nginx.org/en/>Nginx</a>. Instead the application and server are compiled into the same binary and we choose between frameworks. I've been enjoying <a href=https://github.com/tokio-rs/axum>Axum</a> lately, so that's what I used, but I'm sure <a href=https://actix.rs/>Actix</a> or <a href=https://rocket.rs/>Rocket</a> would have been fine too.<p>First, we create a new Rust project and add our dependencies.<pre class=language-bash data-lang=bash style=background:#282828;color:#fdf4c1aa><code class=language-bash data-lang=bash><span style=color:#fdf4c1>$ cargo new avatar </span><span style=color:#fe8019>&& </span><span style=color:#fabd2f>cd</span><span style=color:#fdf4c1> avatar
</span><span style=color:#fdf4c1>$ cargo add axum@0.7.3
</span><span style=color:#fdf4c1>$ cargo add tokio@1.35.1 --features</span><span style=color:#fe8019>=</span><span style=color:#fdf4c1>rt-multi-thread,macros
</span></code></pre><p>Then, we add Axum's <a href=https://en.wikipedia.org/wiki/%22Hello,_World!%22_program>"Hello, World!"</a> example to <code>src/main.rs</code> and build up from there.<pre class=language-rust data-lang=rust style=background:#282828;color:#fdf4c1aa><code class=language-rust data-lang=rust><span style=color:#fa5c4b>use </span><span>axum::{routing::get, Router};
</span><span>
</span><span>#[</span><span style=color:#fdf4c1>tokio</span><span>::</span><span style=color:#fdf4c1>main</span><span>]
</span><span>async </span><span style=color:#fa5c4b>fn </span><span style=color:#8ec07c>main</span><span>() {
</span><span>    </span><span style=color:#fa5c4b>let</span><span> app </span><span style=color:#fe8019>= </span><span>Router::new().</span><span style=color:#fabd2f>route</span><span>(</span><span style=color:#b8bb26>"/"</span><span>, </span><span style=color:#fabd2f>get</span><span>(|| async { </span><span style=color:#b8bb26>"Hello, World!" </span><span>}));
</span><span>
</span><span>    </span><span style=color:#fa5c4b>let</span><span> listener </span><span style=color:#fe8019>= </span><span>tokio::net::TcpListener::bind(</span><span style=color:#b8bb26>"0.0.0.0:3000"</span><span>).await.</span><span style=color:#fabd2f>unwrap</span><span>();
</span><span>    axum::serve(listener, app).await.</span><span style=color:#fabd2f>unwrap</span><span>();
</span><span>}
</span></code></pre><h2 id=getting-the-ip><a aria-label="Anchor link for: getting-the-ip" href=#getting-the-ip></a>Getting the IP</h2><p>Going off the PHP example, the first thing to do is replicate the behavior of <code>$_SERVER['REMOTE_ADDR']</code> and get the IP address of the client connecting to the server. PHP <a href=https://en.wiktionary.org/wiki/automagical>automagically</a> populates <code>$_SERVER</code> with this information, but Axum wants us to be clear about our needs, so this gets a bit more complicated right away.<pre class=language-rust data-lang=rust style=background:#282828;color:#fdf4c1aa><code class=language-rust data-lang=rust><span style=color:#fa5c4b>use </span><span>axum::{extract::ConnectInfo, routing::get, Router};
</span><span style=color:#fa5c4b>use </span><span>std::net::SocketAddr;
</span><span>
</span><span>#[</span><span style=color:#fdf4c1>tokio</span><span>::</span><span style=color:#fdf4c1>main</span><span>]
</span><span>async </span><span style=color:#fa5c4b>fn </span><span style=color:#8ec07c>main</span><span>() {
</span><span>    </span><span style=color:#fa5c4b>let</span><span> app </span><span style=color:#fe8019>= </span><span>Router::new().</span><span style=color:#fabd2f>route</span><span>(
</span><span>        </span><span style=color:#b8bb26>"/"</span><span>,
</span><span>        </span><span style=color:#fabd2f>get</span><span>(|ConnectInfo(</span><span style=color:#fdf4c1>addr</span><span>): ConnectInfo&LTSocketAddr>| async </span><span style=color:#fa5c4b>move </span><span>{
</span><span>            </span><span style=color:#fabd2f>format!</span><span>(</span><span style=color:#b8bb26>"Hello,\n</span><span style=color:#fdf4c1>{}</span><span style=color:#b8bb26>!"</span><span>, addr.</span><span style=color:#fabd2f>ip</span><span>())
</span><span>        }),
</span><span>    );
</span><span>
</span><span>    </span><span style=color:#fa5c4b>let</span><span> listener </span><span style=color:#fe8019>= </span><span>tokio::net::TcpListener::bind(</span><span style=color:#b8bb26>"0.0.0.0:3000"</span><span>).await.</span><span style=color:#fabd2f>unwrap</span><span>();
</span><span>    </span><span style=color:#fa5c4b>let</span><span> make_service </span><span style=color:#fe8019>=</span><span> app.into_make_service_with_connect_info::&LTSocketAddr>();
</span><span>    axum::serve(listener, make_service).await.</span><span style=color:#fabd2f>unwrap</span><span>();
</span><span>}
</span></code></pre><p>Axum also exposes connection information, but not quite as automagically. This information is given to a <a href=https://docs.rs/axum/0.7.1/axum/index.html#handlers>handler</a> (the <a href=https://doc.rust-lang.org/book/ch13-01-closures.html>closure</a> we give to <a href=https://docs.rs/axum/0.7.1/axum/routing/method_routing/fn.get.html><code>get</code></a>) via an <a href=https://docs.rs/axum/0.7.1/axum/index.html#extractors>extractor</a>. If that all sounds very abstract, it's because it is.<p>Specifically, we use the <a href=https://docs.rs/axum/0.7.1/axum/extract/struct.ConnectInfo.html><code>ConnectInfo&LTT></code></a> extractor as an argument to our closure and destructure it to get a <a href=https://doc.rust-lang.org/std/net/enum.SocketAddr.html><code>SocketAddr</code></a> (the desired <code>T</code>). These types can't be inferred, so our handler arguments get a bit verbose. This extractor also requires we create our app using <a href=https://docs.rs/axum/0.7.1/axum/struct.Router.html#method.into_make_service_with_connect_info><code>into_make_service_with_connect_info&LTC></code></a> , which is a long way of saying "let my app get connection info". That behavior is not enabled by default.<p>Astute readers will have noticed that we also added the <a href=https://doc.rust-lang.org/std/keyword.move.html><code>move</code></a> keyword to our <a href=https://doc.rust-lang.org/reference/expressions/block-expr.html#async-blocks><code>async</code> block</a>. Without this our friendly compiler steps in to give a lecture on <a href=https://doc.rust-lang.org/book/ch04-00-understanding-ownership.html>borrowing and ownership</a>.<pre style=background:#282828;color:#fdf4c1aa><code><span><span style=color:#fa5c4b>error[E0373]</span>: async block may outlive the current function, but it borrows `addr`, which is owned by the current function
</span><span>  <span style=color:#458588>--></span> src/main.rs:8:58
</span><span>   <span style=color:#458588>|</span>
</span><span><span style=color:#458588>8  |</span>           get(|ConnectInfo(addr): ConnectInfo&LTSocketAddr>| async {
</span><span>   <span style=color:#458588>|</span>  <span style=color:#fa5c4b>__________________________________________________________^</span>
</span><span><span style=color:#458588>9  |</span> <span style=color:#fa5c4b>|</span>             format!("Hello,\n{}!", addr.ip())
</span><span>   <span style=color:#458588>|</span> <span style=color:#fa5c4b>|</span>                                   <span style=color:#458588>---- `addr` is borrowed here</span>
</span><span><span style=color:#458588>10 |</span> <span style=color:#fa5c4b>|</span>         }),
</span><span>   <span style=color:#458588>|</span> <span style=color:#fa5c4b>|_________^ may outlive borrowed value `addr`</span>
</span><span>   <span style=color:#458588>|</span>
</span><span><span style=color:#98971a>note</span>: async block is returned here
</span><span>  <span style=color:#458588>--></span> src/main.rs:8:58
</span><span>   <span style=color:#458588>|</span>
</span><span><span style=color:#458588>8  |</span>           get(|ConnectInfo(addr): ConnectInfo&LTSocketAddr>| async {
</span><span>   <span style=color:#458588>|</span>  <span style=color:#98971a>__________________________________________________________^</span>
</span><span><span style=color:#458588>9  |</span> <span style=color:#98971a>|</span>             format!("Hello,\n{}!", addr.ip())
</span><span><span style=color:#458588>10 |</span> <span style=color:#98971a>|</span>         }),
</span><span>   <span style=color:#458588>|</span> <span style=color:#98971a>|_________^</span>
</span><span><span style=color:#83a598>help</span>: to force the async block to take ownership of `addr` (and any other referenced variables), use the `move` keyword
</span><span>   <span style=color:#458588>|</span>
</span><span><span style=color:#458588>8  |</span>         get(|ConnectInfo(addr): ConnectInfo&LTSocketAddr>| async <span style=color:#98971a>move</span> {
</span><span>   <span style=color:#458588>|</span>                                                                <span style=color:#98971a>++++</span>
</span><span>
</span><span>For more information about this error, try `rustc --explain E0373`.
</span></code></pre><p>The closure we've written captures <code>addr</code> by reference because <code>addr.ip()</code> borrows <code>self</code>. However, because the return of that closure is the whole <code>async</code> block, itself a <a href=https://doc.rust-lang.org/std/future/trait.Future.html><code>Future</code></a>, that reference is immediately invalidated. Thankfully the compiler warns us and tells us what to do. So helpful! 😎 The <code>move</code> gives ownership of <code>addr</code> to the returned <code>Future</code>.<p>The other way to get around this is to make our handler a function instead of a closure.<pre class=language-rust data-lang=rust style=background:#282828;color:#fdf4c1aa><code class=language-rust data-lang=rust><span>async </span><span style=color:#fa5c4b>fn </span><span style=color:#8ec07c>avatar</span><span>(ConnectInfo(</span><span style=color:#fdf4c1>addr</span><span>): ConnectInfo&LTSocketAddr>) -> String {
</span><span>    </span><span style=color:#fabd2f>format!</span><span>(</span><span style=color:#b8bb26>"Hello,\n</span><span style=color:#fdf4c1>{}</span><span style=color:#b8bb26>"</span><span>, addr.</span><span style=color:#fabd2f>ip</span><span>())
</span><span>}
</span></code></pre><p>This also makes our app declaration prettier, so let's go with that.<pre class=language-rust data-lang=rust style=background:#282828;color:#fdf4c1aa><code class=language-rust data-lang=rust><span style=color:#fa5c4b>let</span><span> app </span><span style=color:#fe8019>= </span><span>Router::new().</span><span style=color:#fabd2f>route</span><span>(</span><span style=color:#b8bb26>"/avatar.png"</span><span>, </span><span style=color:#fabd2f>get</span><span>(avatar));
</span></code></pre><p>Notice that we also changed the route to <code>/avatar.png</code> to match how the PHP was served. We can verify this works as intended with <code>curl</code>.<pre class=language-bash data-lang=bash style=background:#282828;color:#fdf4c1aa><code class=language-bash data-lang=bash><span style=color:#fdf4c1>$ curl http://localhost:3000/avatar.png
</span><span style=color:#fdf4c1>Hello,
</span><span style=color:#fdf4c1>127.0.0.1!
</span></code></pre><h2 id=creating-a-png><a aria-label="Anchor link for: creating-a-png" href=#creating-a-png></a>Creating a PNG</h2><p>Unfortunately, the assignment wasn't to return the client's IP address in plaintext. For parity with the PHP we need to serve an image. Fortunately, the <a href=https://crates.io/crates/image>image</a> crate exists.<pre class=language-bash data-lang=bash style=background:#282828;color:#fdf4c1aa><code class=language-bash data-lang=bash><span style=color:#fdf4c1>$ cargo add image@0.24.7
</span></code></pre><h3 id=background><a aria-label="Anchor link for: background" href=#background></a>Background</h3><p>The image crate allows us to create a PNG in a fashion similar to the PHP. The analog of <code>@imagecreate</code> is to create an <a href=https://docs.rs/image/0.24.7/image/struct.ImageBuffer.html><code>ImageBuffer</code></a>. Instead of <code>imagecolorallocate</code>, the <code>ImageBuffer</code> struct has a convenient <a href=https://docs.rs/image/0.24.7/image/struct.ImageBuffer.html#method.from_pixel><code>from_pixel</code></a> method which allows us to specify a starting pixel that is then copied across our new canvas. We can start with a single <a href=https://docs.rs/image/0.24.7/image/struct.Rgb.html><code>Rgb</code></a> pixel.<pre class=language-rust data-lang=rust style=background:#282828;color:#fdf4c1aa><code class=language-rust data-lang=rust><span style=color:#fa5c4b>use </span><span>image::{ImageBuffer, Rgb};
</span><span>
</span><span style=color:#fa5c4b>const </span><span style=color:#fdf4c1>WIDTH</span><span>: </span><span style=color:#fa5c4b>u32 </span><span style=color:#fe8019>= </span><span style=color:#d3869b>256</span><span>;
</span><span style=color:#fa5c4b>const </span><span style=color:#fdf4c1>HEIGHT</span><span>: </span><span style=color:#fa5c4b>u32 </span><span style=color:#fe8019>= </span><span style=color:#fdf4c1>WIDTH</span><span>;
</span><span style=color:#fa5c4b>const </span><span style=color:#fdf4c1>BACKGROUND_COLOR</span><span>: Rgb<</span><span style=color:#fa5c4b>u8</span><span>> </span><span style=color:#fe8019>=</span><span> Rgb([</span><span style=color:#d3869b>177</span><span>, </span><span style=color:#d3869b>98</span><span>, </span><span style=color:#d3869b>134</span><span>]);
</span><span>
</span><span style=font-style:italic;color:#928374>// ...
</span><span>
</span><span style=color:#fa5c4b>let</span><span> img </span><span style=color:#fe8019>= </span><span>ImageBuffer::from_pixel(</span><span style=color:#fdf4c1>WIDTH</span><span>, </span><span style=color:#fdf4c1>HEIGHT</span><span>, </span><span style=color:#fdf4c1>BACKGROUND_COLOR</span><span>);
</span></code></pre><h3 id=file-format><a aria-label="Anchor link for: file-format" href=#file-format></a>File Format</h3><p>The resulting image buffer is not yet an image though. It's pretty much still a multi-dimensional array of integers. To construct a PNG someone can actually see we need to jam those integers into the <a href=https://en.wikipedia.org/wiki/PNG#File_format>PNG file format</a>. Sadly for us, the equivalent of PHP's <code>imagepng</code> is nowhere near as convenient.<p>If you use <code>ImageBuffer</code>'s <a href=https://docs.rs/image/0.24.7/image/struct.ImageBuffer.html#method.save><code>save</code></a> method to write the buffer out as a file<pre class=language-rust data-lang=rust style=background:#282828;color:#fdf4c1aa><code class=language-rust data-lang=rust><span>img.</span><span style=color:#fabd2f>save</span><span>(</span><span style=color:#b8bb26>"avatar.png"</span><span>).</span><span style=color:#fabd2f>unwrap</span><span>();
</span></code></pre><p>you'll get a blank canvas like this.<div style=display:flex;align-items:center;justify-content:center><img alt="Nothing
but a pinkish/purple background color." src=blank-canvas.png style=height:256px;width:256px></div><p>Sure enough, that's a PNG, but using <code>save</code> is disastrous to us for a few reasons.<ul><li><p>The image is written to the filesystem. To serve its contents to the client we'd have to read it from disk, which is <strong>SLOW</strong>.</p><li><p>Even if it wasn't slow we'd have concurrency issues. Clients could encounter half-written images or incorrect IP addresses from other clients.</p><li><p>Even if the above weren't issues, the <code>save</code> method is written to assume synchronous I/O and Axum is an asynchronous web framework. We'd need to spawn a <a href=https://docs.rs/tokio/1.34.0/tokio/task/fn.spawn_blocking.html>background task</a> to keep it from blocking others.</p></ul><p>Instead, <code>ImageBuffer</code> has a <a href=https://docs.rs/image/0.24.7/image/struct.ImageBuffer.html#method.write_to><code>write_to</code></a> method which<blockquote><p>[w]rites the buffer to a writer in the specified format.</blockquote><p>In this case a "writer" is some type, <code>W</code>, which implements the <a href=https://doc.rust-lang.org/std/io/trait.Write.html><code>Write</code></a> and <a href=https://doc.rust-lang.org/std/io/trait.Seek.html><code>Seek</code></a> traits. Rust's standard library gives us such a <code>W</code> in the form of <a href=https://doc.rust-lang.org/std/io/struct.Cursor.html><code>std::io::Cursor&LTT></code></a>. We can use a <a href=https://doc.rust-lang.org/std/vec/struct.Vec.html><code>Vec&LTu8></code></a> for our cursor's buffer type, <code>T</code>.<pre class=language-rust data-lang=rust style=background:#282828;color:#fdf4c1aa><code class=language-rust data-lang=rust><span style=color:#fa5c4b>let mut</span><span> cursor </span><span style=color:#fe8019>= </span><span>Cursor::new(</span><span style=color:#fabd2f>vec!</span><span>[]);
</span></code></pre><p>As for the "specified format", <code>save</code> has some logic to infer output format from file extension, but with <code>write_to</code> we can just pass <a href=https://docs.rs/image/0.24.7/image/enum.ImageOutputFormat.html#variant.Png><code>ImageOutputFormat::Png</code></a>.<pre class=language-rust data-lang=rust style=background:#282828;color:#fdf4c1aa><code class=language-rust data-lang=rust><span>img.</span><span style=color:#fabd2f>write_to</span><span>(</span><span style=color:#fe8019>&</span><span style=color:#fa5c4b>mut</span><span> cursor, ImageOutputFormat::Png).</span><span style=color:#fabd2f>unwrap</span><span>();
</span></code></pre><p>The <code>Vec&LTu8></code> wrapped by our cursor now contains all the bytes for a proper (albeit blank) PNG. We can work with that <code>Vec&LTu8></code> directly by consuming the cursor with <a href=https://doc.rust-lang.org/std/io/struct.Cursor.html#method.into_inner><code>into_inner</code></a>.<h3 id=serving-the-image><a aria-label="Anchor link for: serving-the-image" href=#serving-the-image></a>Serving the Image</h3><p>At this point we need to tell Axum how to serve the image we've created. How do we turn a <code>Vec&LTu8></code> into a response that a client will understand as an image?<p>Axum knows how to serve <code>Vec&LTu8></code> out of the box, but if we change the handler's signature to return just that we'll have undesired behavior.<pre class=language-rust data-lang=rust style=background:#282828;color:#fdf4c1aa><code class=language-rust data-lang=rust><span>async </span><span style=color:#fa5c4b>fn </span><span style=color:#8ec07c>avatar</span><span>(ConnectInfo(</span><span style=color:#fdf4c1>addr</span><span>): ConnectInfo&LTSocketAddr>) -> </span><span style=color:#fabd2f>Vec</span><span><</span><span style=color:#fa5c4b>u8</span><span>> {
</span><span>    </span><span style=font-style:italic;color:#928374>// ..
</span><span>    cursor.</span><span style=color:#fabd2f>into_inner</span><span>()
</span><span>}
</span></code></pre><p>Check that with <code>curl</code> and you'll see a response like<pre class=language-bash data-lang=bash style=background:#282828;color:#fdf4c1aa><code class=language-bash data-lang=bash><span style=color:#fdf4c1>$ curl --head http://localhost:3000/avatar.png
</span><span style=color:#fdf4c1>HTTP/1.1 200 OK
</span><span style=color:#fdf4c1>content-type: application/octet-stream
</span><span style=color:#fdf4c1>content-length: 1726
</span><span style=color:#fdf4c1>date: Thu, 28 Dec 2023 02:30:17 GMT
</span></code></pre><p>Note that the <code>Content-Type</code> header is <a href=https://www.iana.org/assignments/media-types/application/octet-stream><code>application/octet-stream</code></a> and <strong>not</strong> <a href=https://www.iana.org/assignments/media-types/image/png><code>image/png</code></a>. We need analogs for PHP's <code>header</code> and <code>imagepng</code> in order to tell the client the response is a PNG.<p>We could build an appropriate <a href=https://docs.rs/http/1.0.0/http/response/struct.Response.html><code>Response</code></a> ourselves, but the magic of Axum's <a href=https://docs.rs/axum/0.7.1/axum/response/trait.IntoResponse.html><code>IntoResponse</code></a> trait provides a clear, terse syntax for this that I find preferable.<pre class=language-rust data-lang=rust style=background:#282828;color:#fdf4c1aa><code class=language-rust data-lang=rust><span>async </span><span style=color:#fa5c4b>fn </span><span style=color:#8ec07c>avatar</span><span>(ConnectInfo(</span><span style=color:#fdf4c1>addr</span><span>): ConnectInfo&LTSocketAddr>) -> impl IntoResponse {
</span><span>    </span><span style=font-style:italic;color:#928374>// ...
</span><span>    ([(header::</span><span style=color:#fdf4c1>CONTENT_TYPE</span><span>, </span><span style=color:#b8bb26>"image/png"</span><span>)], cursor.</span><span style=color:#fabd2f>into_inner</span><span>())
</span><span>}
</span></code></pre><p>We return a tuple with an array mapping header names to values and the bytes for the body. Axum's <a href=https://users.rust-lang.org/t/what-are-blanket-implementations/49904>blanket implementations</a> for <code>IntoResponse</code> do all the work to figure out how to turn that into an HTTP response.<p>Putting it all together our current handler looks like this.<pre class=language-rust data-lang=rust style=background:#282828;color:#fdf4c1aa><code class=language-rust data-lang=rust><span>async </span><span style=color:#fa5c4b>fn </span><span style=color:#8ec07c>avatar</span><span>(ConnectInfo(</span><span style=color:#fdf4c1>addr</span><span>): ConnectInfo&LTSocketAddr>) -> impl IntoResponse {
</span><span>    </span><span style=color:#fa5c4b>let</span><span> _text </span><span style=color:#fe8019>= </span><span style=color:#fabd2f>format!</span><span>(</span><span style=color:#b8bb26>"Hello,\n</span><span style=color:#fdf4c1>{}</span><span style=color:#b8bb26>"</span><span>, addr.</span><span style=color:#fabd2f>ip</span><span>());
</span><span>    </span><span style=color:#fa5c4b>let</span><span> img </span><span style=color:#fe8019>= </span><span>ImageBuffer::from_pixel(</span><span style=color:#fdf4c1>WIDTH</span><span>, </span><span style=color:#fdf4c1>HEIGHT</span><span>, </span><span style=color:#fdf4c1>BACKGROUND_COLOR</span><span>);
</span><span>
</span><span>    </span><span style=color:#fa5c4b>let mut</span><span> cursor </span><span style=color:#fe8019>= </span><span>Cursor::new(</span><span style=color:#fabd2f>vec!</span><span>[]);
</span><span>    img.</span><span style=color:#fabd2f>write_to</span><span>(</span><span style=color:#fe8019>&</span><span style=color:#fa5c4b>mut</span><span> cursor, ImageOutputFormat::Png).</span><span style=color:#fabd2f>unwrap</span><span>();
</span><span>
</span><span>    ([(header::</span><span style=color:#fdf4c1>CONTENT_TYPE</span><span>, </span><span style=color:#b8bb26>"image/png"</span><span>)], cursor.</span><span style=color:#fabd2f>into_inner</span><span>())
</span><span>}
</span></code></pre><p>The <code>_text</code> is notably being ignored right now. We can get IP addresses, we can create PNGs, and we can serve them. Now what remains is to put the text in the image.<h3 id=adding-text><a aria-label="Anchor link for: adding-text" href=#adding-text></a>Adding Text</h3><p>For the Rust analog of PHP's <code>imagettftext</code> we need a way to draw text on our image. The <code>image</code> crate doesn't provide any routines for manipulating text, but it does recommend the <a href=https://docs.rs/imageproc/0.23.0/imageproc/index.html><code>imageproc</code></a> crate, which is maintained by the same organization.<pre class=language-bash data-lang=bash style=background:#282828;color:#fdf4c1aa><code class=language-bash data-lang=bash><span style=color:#fdf4c1>$ cargo add imageproc@0.23.0
</span></code></pre><p>This crate provides a <a href=https://docs.rs/imageproc/0.23.0/imageproc/drawing/fn.draw_text_mut.html><code>draw_text_mut</code></a> function, which will draw text onto an existing image. From its signature we can gather it needs a whopping 7 arguments (PHP's <code>imagettftext</code> is 8, so maybe I shouldn't complain). Naturally, these aren't really documented, but we can learn a lot from Rust signatures alone.<ul><li><code>canvas</code> — Any type that implements <code>imageproc</code>'s <a href=https://docs.rs/imageproc/0.23.0/imageproc/drawing/trait.Canvas.html><code>Canvas</code></a> trait.<li><code>color</code> — Any <a href=https://docs.rs/image/0.24.7/image/trait.Pixel.html><code>Pixel</code></a> which can be drawn on that <code>canvas</code>.<li><code>x</code> — The x-coordinate at which to start drawing the text.<li><code>y</code> — The y-coordinate at which to start drawing the text.<li><code>scale</code> — The <a href=https://docs.rs/rusttype/0.9.3/rusttype/struct.Scale.html><code>Scale</code></a> of the font face used when drawing the text.<li><code>font</code> — The <a href=https://docs.rs/rusttype/0.9.3/rusttype/enum.Font.html><code>Font</code></a> the text should be drawn in.<li><code>text</code> — The text itself.</ul><p>That feels like a lot, but we already have most of what we need. Luckily our existing <code>ImageBuffer</code> satisfies the <code>Canvas</code> trait and we already know it's using <code>Rgb</code> pixels which satisfy the <code>Pixel</code> trait. The <code>x</code> and <code>y</code> coordinates were given in the original PHP and we already have our <code>_text</code>. We only need a <code>Scale</code> and a <code>Font</code>. To work with both we'll need the <a href=https://docs.rs/rusttype/0.9.3/rusttype/index.html><code>rusttype</code></a> crate.<pre class=language-bash data-lang=bash style=background:#282828;color:#fdf4c1aa><code class=language-bash data-lang=bash><span style=color:#fdf4c1>$ cargo add rusttype@0.9.3
</span></code></pre><h4 id=getting-a-font><a aria-label="Anchor link for: getting-a-font" href=#getting-a-font></a>Getting a Font</h4><p>The font used in the original PHP was <a href=https://design.ubuntu.com/font>Ubuntu Mono</a>, which is freely available for download. We just need to put the file alongside our Rust code.<p>In PHP-land with <code>imagettftext</code> we just specified the path to a TrueType font file (<code>UbuntuMono-Regular.ttf</code>) and went on our merry way. Our Rust libraries want us to create a <code>Font</code>, which requires us to load the contents of that font file into our application.<p>We could do this on every request, which I think is what the PHP does. Or, we could do one better and bake the font directly into our application with Rust's <a href=https://doc.rust-lang.org/std/macro.include_bytes.html><code>include_bytes!</code></a> macro. I threw in the <a href=https://doc.rust-lang.org/std/macro.concat.html><code>concat!</code></a> and <a href=https://doc.rust-lang.org/std/macro.env.html><code>env!</code></a> macros as well for completeness.<pre class=language-rust data-lang=rust style=background:#282828;color:#fdf4c1aa><code class=language-rust data-lang=rust><span style=color:#fa5c4b>const </span><span style=color:#fdf4c1>FONT_DATA</span><span>: </span><span style=color:#fe8019>&</span><span>[</span><span style=color:#fa5c4b>u8</span><span>] </span><span style=color:#fe8019>= </span><span style=color:#fabd2f>include_bytes!</span><span>(</span><span style=color:#fabd2f>concat!</span><span>(
</span><span>    </span><span style=color:#fabd2f>env!</span><span>(</span><span style=color:#b8bb26>"CARGO_MANIFEST_DIR"</span><span>),
</span><span>    </span><span style=color:#b8bb26>"/fonts/UbuntuMono-R.ttf"
</span><span>));
</span><span>
</span><span style=font-style:italic;color:#928374>// ...
</span><span>
</span><span style=color:#fa5c4b>let</span><span> font </span><span style=color:#fe8019>= </span><span>Font::try_from_bytes(</span><span style=color:#fdf4c1>FONT_DATA</span><span>).</span><span style=color:#fabd2f>unwrap</span><span>();
</span></code></pre><p>Unfortunately, while the <code>FONT_DATA</code> can be <a href=https://doc.rust-lang.org/std/keyword.const.html><code>const</code></a> the <code>Font</code> itself can't, but we can work with this for now.<h4 id=setting-a-scale><a aria-label="Anchor link for: setting-a-scale" href=#setting-a-scale></a>Setting a Scale</h4><p>The last piece of information we need to draw text is a font <code>Scale</code>. According to the docs the scale is defined in <a href=https://en.wikipedia.org/wiki/Pixel>pixels</a>. However, PHP's <code>imagettftext</code> specifies a size in <a href=https://en.wikipedia.org/wiki/Point_(typography)>points</a>. The difference between pixels and points is a <a href=https://graphicdesign.stackexchange.com/questions/199/point-vs-pixel-what-is-the-difference>tricky business</a>, but for our purposes we can take the <em>Easy Mode</em> ™ route by assuming that a point is defined at a 3:4 ratio to a pixel. Thus, from the original font size of <code>24</code> we arrive at a scale of <code>32</code>.<pre class=language-rust data-lang=rust style=background:#282828;color:#fdf4c1aa><code class=language-rust data-lang=rust><span style=color:#fa5c4b>const </span><span style=color:#fdf4c1>SCALE</span><span>: Scale </span><span style=color:#fe8019>=</span><span> Scale { x: </span><span style=color:#d3869b>32.0</span><span>, y: </span><span style=color:#d3869b>32.0 </span><span>};
</span></code></pre><h4 id=putting-it-all-together><a aria-label="Anchor link for: putting-it-all-together" href=#putting-it-all-together></a>Putting It All Together</h4><p>With <code>Font</code>, <code>Scale</code>, and all our other arguments in hand we can finally draw text on the image.<pre class=language-rust data-lang=rust style=background:#282828;color:#fdf4c1aa><code class=language-rust data-lang=rust><span style=color:#fa5c4b>const</span><span> X: </span><span style=color:#fa5c4b>i32 </span><span style=color:#fe8019>= </span><span style=color:#d3869b>8</span><span>;
</span><span style=color:#fa5c4b>const</span><span> Y: </span><span style=color:#fa5c4b>i32 </span><span style=color:#fe8019>= </span><span style=color:#d3869b>96</span><span>;
</span><span style=color:#fa5c4b>const </span><span style=color:#fdf4c1>WIDTH</span><span>: </span><span style=color:#fa5c4b>u32 </span><span style=color:#fe8019>= </span><span style=color:#d3869b>256</span><span>;
</span><span style=color:#fa5c4b>const </span><span style=color:#fdf4c1>HEIGHT</span><span>: </span><span style=color:#fa5c4b>u32 </span><span style=color:#fe8019>= </span><span style=color:#fdf4c1>WIDTH</span><span>;
</span><span style=color:#fa5c4b>const </span><span style=color:#fdf4c1>TEXT_COLOR</span><span>: Rgb<</span><span style=color:#fa5c4b>u8</span><span>> </span><span style=color:#fe8019>=</span><span> Rgb([</span><span style=color:#d3869b>235</span><span>, </span><span style=color:#d3869b>219</span><span>, </span><span style=color:#d3869b>178</span><span>]);
</span><span style=color:#fa5c4b>const </span><span style=color:#fdf4c1>BACKGROUND_COLOR</span><span>: Rgb<</span><span style=color:#fa5c4b>u8</span><span>> </span><span style=color:#fe8019>=</span><span> Rgb([</span><span style=color:#d3869b>177</span><span>, </span><span style=color:#d3869b>98</span><span>, </span><span style=color:#d3869b>134</span><span>]);
</span><span style=color:#fa5c4b>const </span><span style=color:#fdf4c1>SCALE</span><span>: Scale </span><span style=color:#fe8019>=</span><span> Scale { x: </span><span style=color:#d3869b>32.0</span><span>, y: </span><span style=color:#d3869b>32.0 </span><span>};
</span><span style=color:#fa5c4b>const </span><span style=color:#fdf4c1>FONT_DATA</span><span>: </span><span style=color:#fe8019>&</span><span>[</span><span style=color:#fa5c4b>u8</span><span>] </span><span style=color:#fe8019>= </span><span style=color:#fabd2f>include_bytes!</span><span>(</span><span style=color:#fabd2f>concat!</span><span>(
</span><span>    </span><span style=color:#fabd2f>env!</span><span>(</span><span style=color:#b8bb26>"CARGO_MANIFEST_DIR"</span><span>),
</span><span>    </span><span style=color:#b8bb26>"/fonts/UbuntuMono-R.ttf"
</span><span>));
</span><span>
</span><span>async </span><span style=color:#fa5c4b>fn </span><span style=color:#8ec07c>avatar</span><span>(ConnectInfo(</span><span style=color:#fdf4c1>addr</span><span>): ConnectInfo&LTSocketAddr>) -> impl IntoResponse {
</span><span>    </span><span style=color:#fa5c4b>let</span><span> text </span><span style=color:#fe8019>= </span><span style=color:#fabd2f>format!</span><span>(</span><span style=color:#b8bb26>"Hello,\n</span><span style=color:#fdf4c1>{}</span><span style=color:#b8bb26>"</span><span>, addr.</span><span style=color:#fabd2f>ip</span><span>());
</span><span>    </span><span style=color:#fa5c4b>let</span><span> font </span><span style=color:#fe8019>= </span><span>Font::try_from_bytes(</span><span style=color:#fdf4c1>FONT_DATA</span><span>).</span><span style=color:#fabd2f>unwrap</span><span>();
</span><span>    </span><span style=color:#fa5c4b>let mut</span><span> img </span><span style=color:#fe8019>= </span><span>ImageBuffer::from_pixel(</span><span style=color:#fdf4c1>WIDTH</span><span>, </span><span style=color:#fdf4c1>HEIGHT</span><span>, </span><span style=color:#fdf4c1>BACKGROUND_COLOR</span><span>);
</span><span>    </span><span style=color:#fabd2f>draw_text_mut</span><span>(</span><span style=color:#fe8019>&</span><span style=color:#fa5c4b>mut</span><span> img, </span><span style=color:#fdf4c1>TEXT_COLOR</span><span>, X, Y, </span><span style=color:#fdf4c1>SCALE</span><span>, </span><span style=color:#fe8019>&</span><span>font, </span><span style=color:#fe8019>&</span><span>text);
</span><span>
</span><span>    </span><span style=color:#fa5c4b>let mut</span><span> cursor </span><span style=color:#fe8019>= </span><span>Cursor::new(</span><span style=color:#fabd2f>vec!</span><span>[]);
</span><span>    img.</span><span style=color:#fabd2f>write_to</span><span>(</span><span style=color:#fe8019>&</span><span style=color:#fa5c4b>mut</span><span> cursor, ImageOutputFormat::Png).</span><span style=color:#fabd2f>unwrap</span><span>();
</span><span>
</span><span>    ([(header::</span><span style=color:#fdf4c1>CONTENT_TYPE</span><span>, </span><span style=color:#b8bb26>"image/png"</span><span>)], cursor.</span><span style=color:#fabd2f>into_inner</span><span>())
</span><span>}
</span></code></pre><p>That handler will get us an image that looks something like this.<div style=display:flex;align-items:center;justify-content:center><img alt="White text
on a pinkish/purple background which says 'Hello,□127.0.0.'. After the last . a
1 is only partially visible." src=no-newline.png style=height:256px;width:256px></div><p>Which... doesn't really look right, does it? What the heck is the <code>□</code> and why is the IP address cut off instead of being on a <a href=https://en.wikipedia.org/wiki/Newline>new line</a>?<h4 id=handling-newlines><a aria-label="Anchor link for: handling-newlines" href=#handling-newlines></a>Handling Newlines</h4><p>We find the answer, as we often do, by reading more closely. <code>draw_text_mut</code>'s docs clearly say<blockquote><p>Note that this function <em>does not</em> support newlines, you must do this manually.</blockquote><p>That also offers an explanation for what the <code>□</code> is. By digging into the <code>imageproc</code> source we can see that it ultimately calls <a href=https://docs.rs/rusttype/0.9.3/rusttype/enum.Font.html#method.glyph><code>Font::glyph</code></a>, which says<blockquote><p>Note that code points without corresponding glyphs in this font map to the “.notdef” glyph, glyph 0.</blockquote><p>Since the newline character <code>\n</code> is a <a href=https://en.wikipedia.org/wiki/Control_character>control character</a> it's not in the font itself and thus we get the <a href=https://learn.microsoft.com/en-us/typography/opentype/spec/recom#glyph-0-the-notdef-glyph>.notdef</a> glyph instead. This also explains why the <code>rusttype</code> crate (and by extension <code>imageproc</code>) doesn't support newlines.<p>So how can we "do this manually"? Neither <code>imageproc</code> nor <code>rusttype</code> offer any specific advice. The easiest approach seems to be to just split the text up ourselves and draw what goes on the next line with a new <code>y</code> offset.<pre class=language-rust data-lang=rust style=background:#282828;color:#fdf4c1aa><code class=language-rust data-lang=rust><span>    </span><span style=color:#fa5c4b>let</span><span> ip </span><span style=color:#fe8019>=</span><span> addr.</span><span style=color:#fabd2f>ip</span><span>();
</span><span>    </span><span style=color:#fabd2f>draw_text_mut</span><span>(</span><span style=color:#fe8019>&</span><span style=color:#fa5c4b>mut</span><span> img, </span><span style=color:#fdf4c1>TEXT_COLOR</span><span>, X, Y, </span><span style=color:#fdf4c1>SCALE</span><span>, </span><span style=color:#fe8019>&</span><span>font, </span><span style=color:#b8bb26>"Hello,"</span><span>);
</span><span>    </span><span style=color:#fa5c4b>let</span><span> y </span><span style=color:#fe8019>=</span><span> Y </span><span style=color:#fe8019>+ </span><span style=color:#fdf4c1>SCALE</span><span>.y </span><span style=color:#fe8019>as </span><span style=color:#fa5c4b>i32</span><span>;
</span><span>    </span><span style=color:#fabd2f>draw_text_mut</span><span>(</span><span style=color:#fe8019>&</span><span style=color:#fa5c4b>mut</span><span> img, </span><span style=color:#fdf4c1>TEXT_COLOR</span><span>, X, y, </span><span style=color:#fdf4c1>SCALE</span><span>, </span><span style=color:#fe8019>&</span><span>font, </span><span style=color:#fe8019>&</span><span style=color:#fabd2f>format!</span><span>(</span><span style=color:#b8bb26>"</span><span style=color:#fdf4c1>{ip}</span><span style=color:#b8bb26>!"</span><span>));
</span></code></pre><p>I chose to just add <code>SCALE.y</code> to the original <code>Y</code>, which is playing fast and loose with concepts like <a href=https://en.wikipedia.org/wiki/Leading>line height</a>, but seems to work out well enough. At last, we can reproduce the original PHP with output that looks something like this.<div style=display:flex;align-items:center;justify-content:center><img alt="White
text on a pinkish/purple background which says 'Hello,' on one line and
'127.0.0.1!' on the next." src=localhost-ipv4.png style=height:256px;width:256px></div><h2 id=room-for-improvement><a aria-label="Anchor link for: room-for-improvement" href=#room-for-improvement></a>Room for Improvement</h2><p>I've not gone back and run an old Apache instance, so I can't say with 100% certainty that we've got a pixel perfect replica of the original, but I think it's darn close. There's still more to think about though. Here's a grab bag of potential improvements, some I've made and some I've saved for another day.<h3 id=using-one-font><a aria-label="Anchor link for: using-one-font" href=#using-one-font></a>Using One <code>Font</code></h3><p>Earlier I mentioned that our <code>Font</code> couldn't be <code>const</code>. That's true, but with a little effort it can at least be <code>static</code>. I don't always love globals, but it feels silly to create a new <code>Font</code> on each request when it could be the same darn font every time.<p>I initially thought to use the <a href=https://docs.rs/lazy_static/1.4.0/lazy_static/index.html><code>lazy_static</code></a> crate for this purpose, but since Rust 1.70.0 stablized <a href=https://doc.rust-lang.org/stable/std/sync/struct.OnceLock.html><code>OnceLock</code></a> I thought I'd give that a try. Why not use a standard library approach if you can?<p>Until <a href=https://doc.rust-lang.org/std/sync/struct.LazyLock.html><code>LazyLock</code></a> stablizes it seems like the most ergonomic use of <code>OnceLock</code> for what we want involves creating an accessor function.<pre class=language-rust data-lang=rust style=background:#282828;color:#fdf4c1aa><code class=language-rust data-lang=rust><span style=color:#fa5c4b>use </span><span>std::sync::OnceLock;
</span><span>
</span><span style=color:#fa5c4b>fn </span><span style=color:#8ec07c>font</span><span>() -> </span><span style=color:#fe8019>&</span><span style=color:#fa5c4b>'static </span><span>Font<</span><span style=color:#fa5c4b>'static</span><span>> {
</span><span>    </span><span style=color:#fa5c4b>static </span><span style=color:#fdf4c1>FONT</span><span>: OnceLock&LTFont> </span><span style=color:#fe8019>= </span><span>OnceLock::new();
</span><span>    </span><span style=color:#fdf4c1>FONT</span><span>.</span><span style=color:#fabd2f>get_or_init</span><span>(|| Font::try_from_bytes(</span><span style=color:#fdf4c1>FONT_DATA</span><span>).</span><span style=color:#fabd2f>expect</span><span>(</span><span style=color:#b8bb26>"Built-in font data was invalid"</span><span>))
</span><span>}
</span></code></pre><p>At the call site we just swap a <code>&font</code> for a <code>font()</code> and we're done. One <code>Font</code>.<p>Normally I avoid potential <a href=https://doc.rust-lang.org/std/macro.panic.html>panic</a>s as much as I can, but the only way that <a href=https://docs.rs/rusttype/0.9.3/rusttype/enum.Font.html#method.try_from_bytes><code>Font::try_from_bytes</code></a> can fail is if the <code>.ttf</code> file is invalid at compile time, so I felt comfortable using <a href=https://doc.rust-lang.org/std/option/enum.Option.html#method.expect><code>expect</code></a>.<h3 id=error-handling><a aria-label="Anchor link for: error-handling" href=#error-handling></a>Error Handling</h3><p>Yeah, the PHP just uses <code>or die</code>, but this is Rust, so we should try harder.<p>A panic in a completely unrecoverable situation which indicates your software was built wrong seems acceptable for now, but we should fix all of our <a href=https://doc.rust-lang.org/std/result/enum.Result.html#method.unwrap><code>unwrap</code></a> calls. While not strictly necessary, it helps to have good supporting libraries.<pre class=language-bash data-lang=bash style=background:#282828;color:#fdf4c1aa><code class=language-bash data-lang=bash><span style=color:#fdf4c1>$ cargo add anyhow@1.0.78
</span><span style=color:#fdf4c1>$ cargo add thiserror@1.0.53
</span></code></pre><h4 id=server-errors><a aria-label="Anchor link for: server-errors" href=#server-errors></a>Server Errors</h4><p>The <code>unwrap</code>s in <code>main</code> can be neatly <a href=https://doc.rust-lang.org/std/result/#the-question-mark-operator-><code>?</code></a>'d out of existence with <a href=https://docs.rs/anyhow/1.0.77/anyhow/index.html><code>anyhow</code></a> and <a href=https://doc.rust-lang.org/reference/crates-and-source-files.html#main-functions><code>Result</code> in <code>main</code></a>. If they fail the program can't reasonably continue, but we should try to exit cleanly and allow an admin to read <em>something</em> about what happened.<pre class=language-rust data-lang=rust style=background:#282828;color:#fdf4c1aa><code class=language-rust data-lang=rust><span>#[</span><span style=color:#fdf4c1>tokio</span><span>::</span><span style=color:#fdf4c1>main</span><span>]
</span><span>async </span><span style=color:#fa5c4b>fn </span><span style=color:#8ec07c>main</span><span>() -> anyhow::</span><span style=color:#fabd2f>Result</span><span><()> {
</span><span>    </span><span style=color:#fa5c4b>let</span><span> app </span><span style=color:#fe8019>= </span><span>Router::new().</span><span style=color:#fabd2f>route</span><span>(</span><span style=color:#b8bb26>"/avatar.png"</span><span>, </span><span style=color:#fabd2f>get</span><span>(avatar));
</span><span>
</span><span>    </span><span style=color:#fa5c4b>let</span><span> listener </span><span style=color:#fe8019>= </span><span>tokio::net::TcpListener::bind(</span><span style=color:#b8bb26>"0.0.0.0:3000"</span><span>).await</span><span style=color:#fe8019>?</span><span>;
</span><span>    </span><span style=color:#fa5c4b>let</span><span> make_service </span><span style=color:#fe8019>=</span><span> app.into_make_service_with_connect_info::&LTSocketAddr>();
</span><span>    axum::serve(listener, make_service).await</span><span style=color:#fe8019>?</span><span>;
</span><span>    </span><span style=color:#fabd2f>Ok</span><span>(())
</span><span>}
</span></code></pre><h4 id=handler-errors><a aria-label="Anchor link for: handler-errors" href=#handler-errors></a>Handler Errors</h4><p>The remaining <code>unwrap</code> in <code>avatar</code> benefits from a more careful approach. If converting one <code>ImageBuffer</code> into a <code>Vec&LTu8></code> fails for a single request the whole application shouldn't crash. This failure point comes from<pre class=language-rust data-lang=rust style=background:#282828;color:#fdf4c1aa><code class=language-rust data-lang=rust><span>img.</span><span style=color:#fabd2f>write_to</span><span>(</span><span style=color:#fe8019>&</span><span style=color:#fa5c4b>mut</span><span> cursor, ImageOutputFormat::Png).</span><span style=color:#fabd2f>unwrap</span><span>();
</span></code></pre><p>The <code>write_to</code> method returns a <a href=https://doc.rust-lang.org/std/result/enum.Result.html><code>Result&LTT, E></code></a> whose <code>E</code> is an <a href=https://docs.rs/image/0.24.7/image/error/enum.ImageError.html><code>ImageError</code></a>. Unfortunately, it's not quite as simple as returning <code>Result&LTimpl IntoResponse, image::ImageError></code> from our handler. Trying to do so yields a rare and disappointing mystery compilation error too long to reproduce here.<p>After sleuthing in Axum's <a href=https://docs.rs/axum/0.7.1/axum/error_handling/index.html>error handling docs</a> you can discover that the <code>Err</code> variant for a <code>Result</code> should implement <code>IntoResponse</code> itself. Frustratingly, our application code owns neither the <code>ImageError</code> type nor the <code>IntoResponse</code> trait, so Rust's <a href=https://doc.rust-lang.org/reference/items/implementations.html#trait-implementation-coherence>orphan rules</a> prevent us from implementing this directly ourselves. The easiest solution is to make a wrapper.<pre class=language-rust data-lang=rust style=background:#282828;color:#fdf4c1aa><code class=language-rust data-lang=rust><span>#[</span><span style=color:#fdf4c1>derive</span><span>(Debug, thiserror::Error)]
</span><span>#[</span><span style=color:#fdf4c1>error</span><span>(</span><span style=color:#b8bb26>"Failed to generate image: {0}"</span><span>)]
</span><span style=color:#fa5c4b>struct </span><span style=color:#8ec07c>AvatarError</span><span>(#[from] image::ImageError);
</span></code></pre><p>The <a href=https://docs.rs/thiserror/1.0.52/thiserror/index.html><code>thiserror</code></a> crate makes this blessedly straightforward. An <code>AvatarError</code> wraps an <code>ImageError</code> and can automatically be converted from one thanks to the ease of <code>#[from]</code>.<pre class=language-rust data-lang=rust style=background:#282828;color:#fdf4c1aa><code class=language-rust data-lang=rust><span style=color:#fa5c4b>impl </span><span>IntoResponse </span><span style=color:#fa5c4b>for </span><span style=color:#8ec07c>AvatarError </span><span>{
</span><span>    </span><span style=color:#fa5c4b>fn </span><span style=color:#8ec07c>into_response</span><span>(</span><span style=color:#fdf4c1>self</span><span>) -> axum::response::Response {
</span><span>        (StatusCode::</span><span style=color:#fdf4c1>INTERNAL_SERVER_ERROR</span><span>, </span><span style=color:#fdf4c1>self</span><span>.</span><span style=color:#fabd2f>to_string</span><span>()).</span><span style=color:#fabd2f>into_response</span><span>()
</span><span>    }
</span><span>}
</span></code></pre><p>Having to implement this trait for our own error makes a little more sense now. Without it how could Axum have known that this particular error should be an <a href=https://developer.mozilla.org/en-US/docs/web/http/status/500>Internal Server Error</a>?<p>Now we're allowed to define our handler as<pre class=language-rust data-lang=rust style=background:#282828;color:#fdf4c1aa><code class=language-rust data-lang=rust><span>async </span><span style=color:#fa5c4b>fn </span><span style=color:#8ec07c>avatar</span><span>(
</span><span>    ConnectInfo(</span><span style=color:#fdf4c1>addr</span><span>): ConnectInfo&LTSocketAddr>,
</span><span>) -> </span><span style=color:#fabd2f>Result</span><span>&LTimpl IntoResponse, AvatarError> {
</span><span>    </span><span style=font-style:italic;color:#928374>// ...
</span><span>}
</span></code></pre><p>and we can use <code>?</code> just like we hoped to.<h3 id=ipv6-support><a aria-label="Anchor link for: ipv6-support" href=#ipv6-support></a>IPv6 Support</h3><p>Until now we've assumed that everything is using <a href=https://en.wikipedia.org/wiki/IPv4>IPv4</a>, but it's the tail end of 2023, so we should probably at least think about <a href=https://en.wikipedia.org/wiki/IPv6>IPv6</a>. Unfortunately things get ugly in a hurry.<p>In fairness though, I'm not sure how well the original PHP's<pre class=language-php data-lang=php style=background:#282828;color:#fdf4c1aa><code class=language-php data-lang=php><span>&LT?php
</span><span style=color:#fdf4c1>    $ip </span><span style=color:#fe8019>= </span><span style=color:#fabd2f>explode</span><span style=color:#fdf4c1>(</span><span style=color:#b8bb26>'.'</span><span style=color:#fdf4c1>, $_SERVER[</span><span style=color:#b8bb26>'REMOTE_ADDR'</span><span style=color:#fdf4c1>], </span><span style=color:#d3869b>4</span><span style=color:#fdf4c1>);
</span><span>?>
</span></code></pre><p>handled IPv6, so this is well off the beaten path.<h4 id=allowing-ipv6-connections><a aria-label="Anchor link for: allowing-ipv6-connections" href=#allowing-ipv6-connections></a>Allowing IPv6 Connections</h4><p>With what's been written so far if you try to make an IPv6 connection you're gonna have a bad time.<pre class=language-bash data-lang=bash style=background:#282828;color:#fdf4c1aa><code class=language-bash data-lang=bash><span style=color:#fdf4c1>$ curl -6 http://localhost:3000/avatar.png  
</span><span style=color:#fdf4c1>curl: (7</span><span>) </span><span style=color:#fdf4c1>Failed to connect to localhost port 3000: Connection refused
</span></code></pre><p>This is because we told the server to listen on <a href=https://en.wikipedia.org/wiki/0.0.0.0><code>0.0.0.0</code></a> as a special shorthand for "listen on all network interfaces". <code>0.0.0.0</code> is specific to IPv4, so we aren't listening for any incoming IPv6 connections. We can fix that by listening on <a href=https://en.wikipedia.org/wiki/0.0.0.0#In_IPv6><code>::</code></a>, the IPv6 equivalent.<pre class=language-rust data-lang=rust style=background:#282828;color:#fdf4c1aa><code class=language-rust data-lang=rust><span style=color:#fa5c4b>let</span><span> listener </span><span style=color:#fe8019>= </span><span>tokio::net::TcpListener::bind(</span><span style=color:#b8bb26>"[::]:3000"</span><span>).await</span><span style=color:#fe8019>?</span><span>;
</span></code></pre><p>I've wrapped the <code>::</code> with <code>[]</code> because it helps readability by disambiguating between <code>:</code> as part of the address and <code>:</code> as an address/port separator. Also because <a href=https://datatracker.ietf.org/doc/html/rfc2732>RFC 2732</a> said so.<p>Listening on an IPv6 fixes the problem and also still works for IPv4... <a href=https://serverfault.com/questions/21657/semantics-of-and-0-0-0-0-in-dual-stack-oses/39561#39561>kinda</a>... Apparently the exact semantics are OS-dependent. On Windows it only binds for IPv6 and on Linux it's dependent on kernel configuration.<p>I <em>think</em> in order to make it work in both Windows and Linux you'd have to<ul><li>Listen on <code>::</code>.<li><em>Also</em> listen on <code>0.0.0.0</code>.<li>Spawn two <a href=https://docs.rs/tokio/1.34.0/tokio/task/index.html>tasks</a>, each with their own copy of the app, and put them in a <a href=https://docs.rs/tokio/1.34.0/tokio/task/struct.JoinSet.html><code>JoinSet</code></a>.<li>Hope and pray (or check) that <code>/proc/sys/net/ipv6/bindv6only</code> is set, otherwise Linux will get mad at you because it's <em>already</em> listening on both.</ul><p>I couldn't be bothered. I'd choose to run the application on Linux and I control the kernel, so it's working for me. 🤷‍♂️<h4 id=displaying-ipv4-correctly><a aria-label="Anchor link for: displaying-ipv4-correctly" href=#displaying-ipv4-correctly></a>Displaying IPv4 Correctly</h4><p>Just because we can accept IPv4 and IPv6 connections doesn't mean it's actually working the way we want it to though. Letting <code>::</code> bind both IPv4 and IPv6 has another side effect. IPv4 addresses are interpeted as <a href=https://en.wikipedia.org/wiki/IPv6#IPv4-mapped_IPv6_addresses>IPv4-mapped IPv6 addresses</a>.<p>If you <code>curl</code> via IPv4 specifically with<pre class=language-bash data-lang=bash style=background:#282828;color:#fdf4c1aa><code class=language-bash data-lang=bash><span style=color:#fdf4c1>$ curl -4 -O http://localhost:3000/avatar.png  
</span></code></pre><p>you're likely to see something like this.<div style=display:flex;align-items:center;justify-content:center><img alt="White
text on a pinkish/purple background which says 'Hello,' on one line and
'::ffff:127.0.0.' on the next. After the last . a 1 is only partially
visible." src=ipv4-mapped.png style=height:256px;width:256px></div><p>In this form an IPv4 address like <code>127.0.0.1</code> is represented in an IPv6 address format like <code>::ffff:127.0.0.1</code>. The IPv4 form is the "canonical" form. Luckily Rust's <a href=https://doc.rust-lang.org/std/net/enum.IpAddr.html><code>IpAddr</code></a> type has a method for this, <a href=https://doc.rust-lang.org/std/net/enum.IpAddr.html#method.to_canonical><code>to_canonical</code></a>.<pre class=language-rust data-lang=rust style=background:#282828;color:#fdf4c1aa><code class=language-rust data-lang=rust><span style=color:#fa5c4b>let</span><span> ip </span><span style=color:#fe8019>=</span><span> addr.</span><span style=color:#fabd2f>ip</span><span>().</span><span style=color:#fabd2f>to_canonical</span><span>();
</span></code></pre><p>This was actually just added in <a href=https://blog.rust-lang.org/2023/12/28/Rust-1.75.0.html>Rust 1.75.0</a> mere days ago, well after I started writing this. You can just take my word that this was rather more of a pain in the ass to deal with before that.<p>IPv4 works again!<div style=display:flex;align-items:center;justify-content:center><img alt="White
text on a pinkish/purple background which says 'Hello,' on one line and
'127.0.0.1!' on the next." src=localhost-ipv4.png style=height:256px;width:256px></div><p>IPv6 also works!<div style=display:flex;align-items:center;justify-content:center><img alt="White
text on a pinkish/purple background which says 'Hello,' on one line and '::1!'
on the next." src=localhost-ipv6.png style=height:256px;width:256px></div><p>Haha, just kidding, it absolutely does not. Most IPv6 addresses are way longer than <code>::1</code>.<div style=display:flex;align-items:center;justify-content:center><img alt="White text
on a pinkish/purple background which says 'Hello,' on one line and
'2001:0db8:85a3:' on the next. After the last : a 0 is only partially
visible." src=bad-ipv6.png style=height:256px;width:256px></div><h4 id=displaying-ipv6-correctly><a aria-label="Anchor link for: displaying-ipv6-correctly" href=#displaying-ipv6-correctly></a>Displaying IPv6 Correctly</h4><p>Out of all the problems we've dealt with so far I think this is the thorniest. Unlike with the <a href=https://AliAhmadi2004.ir/posts/avatar-png/#handling-newlines>newline issue</a>, the text simply doesn't fit in the image. At this font size, if you get a real-world IPv6 address you're more than likely going to draw it right off the edge of the canvas.<p>Just decrease the font size, you might say...<div style=display:flex;align-items:center;justify-content:center><img alt="White
text on a pinkish/purple background which says 'Hello,' on one line and
'2001:0db8:85a3:0000:0000:8a2e:0370:7334!' on the next. The text all fits
within the image, but is extremely small compared to similar images and not
easily read." src=font-for-ants.png style=height:256px;width:256px></div><p>Your eyes must be better than mine. That's not easy to read. I had to set the <code>Scale</code> to <code>12.0</code> to make that fit. It looks even sillier with <code>::1</code>, I promise.<p>OK, well just make the PNG wider then!</p><style>.wide-boi{display:flex;align-items:center;justify-content:center;overflow:auto}@media (max-width: 700px){.wide-boi{justify-content:left}}</style><div class=wide-boi><img alt="White text
on a pinkish/purple background which says 'Hello,' on one line and
'2001:0db8:85a3:0000:0000:8a2e:0370:7334!' on the next. The text all fits
within the image, but the image itself is extremely large compared to similar
images." src=wide-boi.png style=height:256px;width:648px></div><p>Cool, now it's <code>648</code> pixels wide. If you're reading on mobile it might well exceed the width of your screen. It <em>also</em> looks silly with <code>::1</code>, btw. Additionally, it likely violates an original constraint that the image be 256 x 256 pixels to serve as a profile picture.<p>Uhh... why are you making this so complicated? We did newlines before, wrap the text!<div style=display:flex;align-items:center;justify-content:center><img alt="White
text on a pinkish/purple background which says 'Hello,' on the first line,
'2001:0db8:85a3:' on the second, '0000:0000:8a2e:' on the third line, and
'0370:7334!' on the fourth line. The text is not centered in the image." src=wrapped-text.png style=height:256px;width:256px></div><p>Huh. Actually, I don't hate that, but it no longer looks centered. Also, IPv6 addresses aren't guaranteed to have a uniform length. There are <a href=https://en.wikipedia.org/wiki/IPv6#Address_representation>several different ways to represent them</a>. For example, <code>2001:0db8:0000:0000:0000:8a2e:0370:7334</code> can also be written as <code>2001:db8::8a2e:370:7334</code>. Furthermore, <a href=https://datatracker.ietf.org/doc/html/rfc5952>RFC 5952</a> recommends that<blockquote><p>Leading zeros MUST be suppressed.</blockquote><p>and<blockquote><p>The use of the symbol "::" MUST be used to its maximum capability.</blockquote><p>so if we play by the rules different addresses might take up a different number of lines. Really, both width and height could be variable depending on our solution.<h4 id=is-there-nothing-we-can-do><a aria-label="Anchor link for: is-there-nothing-we-can-do" href=#is-there-nothing-we-can-do></a>Is There Nothing We Can Do?</h4><p>We've considered 3 solutions, all of which have their own issues.<ol><li>Shrinking the font size. <ul><li>Mostly illegible.</ul><li>Increasing the image width. <ul><li>Looks awkward for variable width addresses.<li>Likely violates an original constraint for 256 x 256 pixels.</ul><li>Wrapping the text. <ul><li>Looks awkward for variable lines.</ul></ol><p>Of the 3 solutions I think text wrapping is the most appropriate, but I ran out of time to pursue an implementation before writing this. I feel comfortable leaving a solution as an exercise to the reader and would love to hear what others would do.<h3 id=svg><a aria-label="Anchor link for: svg" href=#svg></a>SVG</h3><p>I'm sure that by now at least one person has been screaming "Use <a href=https://en.wikipedia.org/wiki/SVG>SVG</a>!" in their mind. Personally, I'm not convinced it's necessarily a better fit, but it's not something I know much about, so I'm open to being wrong.<p>I applied what little I know to create an SVG.<pre class=language-svg data-lang=svg style=background:#282828;color:#fdf4c1aa><code class=language-svg data-lang=svg><span style=color:#83a598><</span><span style=font-weight:700;color:#8ec07c>svg </span><span style=color:#8ec07c>width=</span><span style=color:#b8bb26>"256" </span><span style=color:#8ec07c>height=</span><span style=color:#b8bb26>"256" </span><span style=color:#8ec07c>xmlns=</span><span style=color:#b8bb26>"http://www.w3.org/2000/svg"</span><span style=color:#83a598>>
</span><span>  </span><span style=color:#83a598><</span><span style=font-weight:700;color:#8ec07c>style</span><span style=color:#83a598>>
</span><span>  @font-face {
</span><span>    font-family: "Ubuntu Mono";
</span><span>    src: url(/fonts/UbuntuMono-Regular.ttf) format('truetype');
</span><span>  }
</span><span>  </span><span style=color:#83a598>&LT/</span><span style=font-weight:700;color:#8ec07c>style</span><span style=color:#83a598>>
</span><span>  </span><span style=color:#83a598><</span><span style=font-weight:700;color:#8ec07c>rect </span><span style=color:#8ec07c>width=</span><span style=color:#b8bb26>"100%" </span><span style=color:#8ec07c>height=</span><span style=color:#b8bb26>"100%" </span><span style=color:#8ec07c>fill=</span><span style=color:#b8bb26>"#12cc44"</span><span style=color:#83a598>/>
</span><span>  </span><span style=color:#83a598><</span><span style=font-weight:700;color:#8ec07c>text </span><span style=color:#8ec07c>x=</span><span style=color:#b8bb26>"8" </span><span style=color:#8ec07c>y=</span><span style=color:#b8bb26>"96" </span><span style=color:#8ec07c>font-size=</span><span style=color:#b8bb26>"24" </span><span style=color:#8ec07c>font-family=</span><span style=color:#b8bb26>"Ubuntu Mono" </span><span style=color:#8ec07c>fill=</span><span style=color:#b8bb26>"#ebdbb2"</span><span style=color:#83a598>>
</span><span>    </span><span style=color:#83a598><</span><span style=font-weight:700;color:#8ec07c>tspan </span><span style=color:#8ec07c>x=</span><span style=color:#b8bb26>"0" </span><span style=color:#8ec07c>dy=</span><span style=color:#b8bb26>"1em"</span><span style=color:#83a598>></span><span>Hello,</span><span style=color:#83a598>&LT/</span><span style=font-weight:700;color:#8ec07c>tspan</span><span style=color:#83a598>>
</span><span>    </span><span style=color:#83a598><</span><span style=font-weight:700;color:#8ec07c>tspan </span><span style=color:#8ec07c>x=</span><span style=color:#b8bb26>"0" </span><span style=color:#8ec07c>dy=</span><span style=color:#b8bb26>"1em"</span><span style=color:#83a598>></span><span>127.0.0.1!</span><span style=color:#83a598>&LT/</span><span style=font-weight:700;color:#8ec07c>tspan</span><span style=color:#83a598>>
</span><span>  </span><span style=color:#83a598>&LT/</span><span style=font-weight:700;color:#8ec07c>text</span><span style=color:#83a598>>
</span><span style=color:#83a598>&LT/</span><span style=font-weight:700;color:#8ec07c>svg</span><span style=color:#83a598>>
</span></code></pre><p>I left the font out for this particular image, but it yields something like this.<div style=display:flex;align-items:center;justify-content:center><svg height=256 width=256 xmlns=http://www.w3.org/2000/svg><rect fill=#12cc44 height=100% width=100% /><text fill=#ebdbb2 font-family=monospace font-size=24 x=8 y=96><tspan dy=1em x=0>Hello,</tspan> <tspan dy=1em x=0>127.0.0.1!</tspan></text></svg></div><p>Here are my observations given what I assume about SVGs, PNGs, and this problem.<h4 id=benefits><a aria-label="Anchor link for: benefits" href=#benefits></a>Benefits</h4><ul><li>The font looks smoother as a vector graphic than in a raster image when zoomed in.<li>The SVG above is all of 435 bytes for the client to download.<li>Supports font fallback if the font can't be downloaded.<li>You can copy the text out of it!</ul><h4 id=downsides><a aria-label="Anchor link for: downsides" href=#downsides></a>Downsides</h4><ul><li>The SVG might be 435 bytes, but the <code>.ttf</code> file is ~205KB. Most PNGs in this post are &LT10KB.<li>Neither newlines nor line wrapping in general appear to be solved, at least not in <a href=https://developer.mozilla.org/en-US/docs/Web/SVG/Element/tspan><code>text</code></a>.<li>Likely would not have been supported by the original target client.</ul><p>I don't see the benefits hugely outweighing the downsides, especially when keeping in mind what likely would have been the original constraints. What we've got should do for now.<h2 id=the-finished-product><a aria-label="Anchor link for: the-finished-product" href=#the-finished-product></a>The Finished Product</h2><p>I can't believe you read this far. The final code is available on <a href=https://github.com/reillysiemens/avatar/tree/ee21f6161d3ab64f40f9e6b762ff4d0c931d2ac9>GitHub</a>, but this post didn't feel complete without putting everything I talked about in one place for comparision with the <a href=https://AliAhmadi2004.ir/posts/avatar-png/#php>PHP</a>.<p>It's significantly longer than the original and probably more complicated than it needs to be, but it mostly works and that's worth something.<pre class=language-rust data-lang=rust style=background:#282828;color:#fdf4c1aa><code class=language-rust data-lang=rust><span style=color:#fa5c4b>use </span><span>std::{io::Cursor, net::SocketAddr, sync::OnceLock};
</span><span>
</span><span style=color:#fa5c4b>use </span><span>axum::{
</span><span>    extract::ConnectInfo,
</span><span>    http::{header, StatusCode},
</span><span>    response::IntoResponse,
</span><span>    routing::get,
</span><span>    Router,
</span><span>};
</span><span style=color:#fa5c4b>use </span><span>image::{ImageBuffer, ImageOutputFormat, Rgb};
</span><span style=color:#fa5c4b>use </span><span>imageproc::drawing::draw_text_mut;
</span><span style=color:#fa5c4b>use </span><span>rusttype::{Font, Scale};
</span><span>
</span><span style=color:#fa5c4b>const</span><span> X: </span><span style=color:#fa5c4b>i32 </span><span style=color:#fe8019>= </span><span style=color:#d3869b>8</span><span>;
</span><span style=color:#fa5c4b>const</span><span> Y: </span><span style=color:#fa5c4b>i32 </span><span style=color:#fe8019>= </span><span style=color:#d3869b>96</span><span>;
</span><span style=color:#fa5c4b>const </span><span style=color:#fdf4c1>WIDTH</span><span>: </span><span style=color:#fa5c4b>u32 </span><span style=color:#fe8019>= </span><span style=color:#d3869b>256</span><span>;
</span><span style=color:#fa5c4b>const </span><span style=color:#fdf4c1>HEIGHT</span><span>: </span><span style=color:#fa5c4b>u32 </span><span style=color:#fe8019>= </span><span style=color:#fdf4c1>WIDTH</span><span>;
</span><span style=color:#fa5c4b>const </span><span style=color:#fdf4c1>TEXT_COLOR</span><span>: Rgb<</span><span style=color:#fa5c4b>u8</span><span>> </span><span style=color:#fe8019>=</span><span> Rgb([</span><span style=color:#d3869b>235</span><span>, </span><span style=color:#d3869b>219</span><span>, </span><span style=color:#d3869b>178</span><span>]);
</span><span style=color:#fa5c4b>const </span><span style=color:#fdf4c1>BACKGROUND_COLOR</span><span>: Rgb<</span><span style=color:#fa5c4b>u8</span><span>> </span><span style=color:#fe8019>=</span><span> Rgb([</span><span style=color:#d3869b>177</span><span>, </span><span style=color:#d3869b>98</span><span>, </span><span style=color:#d3869b>134</span><span>]);
</span><span style=color:#fa5c4b>const </span><span style=color:#fdf4c1>SCALE</span><span>: Scale </span><span style=color:#fe8019>=</span><span> Scale { x: </span><span style=color:#d3869b>32.0</span><span>, y: </span><span style=color:#d3869b>32.0 </span><span>};
</span><span style=color:#fa5c4b>const </span><span style=color:#fdf4c1>FONT_DATA</span><span>: </span><span style=color:#fe8019>&</span><span>[</span><span style=color:#fa5c4b>u8</span><span>] </span><span style=color:#fe8019>= </span><span style=color:#fabd2f>include_bytes!</span><span>(</span><span style=color:#fabd2f>concat!</span><span>(
</span><span>    </span><span style=color:#fabd2f>env!</span><span>(</span><span style=color:#b8bb26>"CARGO_MANIFEST_DIR"</span><span>),
</span><span>    </span><span style=color:#b8bb26>"/fonts/UbuntuMono-R.ttf"
</span><span>));
</span><span>
</span><span>#[</span><span style=color:#fdf4c1>derive</span><span>(Debug, thiserror::Error)]
</span><span>#[</span><span style=color:#fdf4c1>error</span><span>(</span><span style=color:#b8bb26>"Failed to generate image: {0}"</span><span>)]
</span><span style=color:#fa5c4b>struct </span><span style=color:#8ec07c>AvatarError</span><span>(#[from] image::ImageError);
</span><span>
</span><span style=color:#fa5c4b>impl </span><span>IntoResponse </span><span style=color:#fa5c4b>for </span><span style=color:#8ec07c>AvatarError </span><span>{
</span><span>    </span><span style=color:#fa5c4b>fn </span><span style=color:#8ec07c>into_response</span><span>(</span><span style=color:#fdf4c1>self</span><span>) -> axum::response::Response {
</span><span>        (StatusCode::</span><span style=color:#fdf4c1>INTERNAL_SERVER_ERROR</span><span>, </span><span style=color:#fdf4c1>self</span><span>.</span><span style=color:#fabd2f>to_string</span><span>()).</span><span style=color:#fabd2f>into_response</span><span>()
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#fa5c4b>fn </span><span style=color:#8ec07c>font</span><span>() -> </span><span style=color:#fe8019>&</span><span style=color:#fa5c4b>'static </span><span>Font<</span><span style=color:#fa5c4b>'static</span><span>> {
</span><span>    </span><span style=color:#fa5c4b>static </span><span style=color:#fdf4c1>FONT</span><span>: OnceLock&LTFont> </span><span style=color:#fe8019>= </span><span>OnceLock::new();
</span><span>    </span><span style=color:#fdf4c1>FONT</span><span>.</span><span style=color:#fabd2f>get_or_init</span><span>(|| Font::try_from_bytes(</span><span style=color:#fdf4c1>FONT_DATA</span><span>).</span><span style=color:#fabd2f>expect</span><span>(</span><span style=color:#b8bb26>"Built-in font data was invalid"</span><span>))
</span><span>}
</span><span>
</span><span>async </span><span style=color:#fa5c4b>fn </span><span style=color:#8ec07c>avatar</span><span>(
</span><span>    ConnectInfo(</span><span style=color:#fdf4c1>addr</span><span>): ConnectInfo&LTSocketAddr>,
</span><span>) -> </span><span style=color:#fabd2f>Result</span><span>&LTimpl IntoResponse, AvatarError> {
</span><span>    </span><span style=font-style:italic;color:#928374>// Wow, IPv6 causes a lot of headache. 😵‍💫
</span><span>    </span><span style=color:#fa5c4b>let</span><span> ip </span><span style=color:#fe8019>=</span><span> addr.</span><span style=color:#fabd2f>ip</span><span>().</span><span style=color:#fabd2f>to_canonical</span><span>();
</span><span>    </span><span style=color:#fa5c4b>let mut</span><span> img </span><span style=color:#fe8019>= </span><span>ImageBuffer::from_pixel(</span><span style=color:#fdf4c1>WIDTH</span><span>, </span><span style=color:#fdf4c1>HEIGHT</span><span>, </span><span style=color:#fdf4c1>BACKGROUND_COLOR</span><span>);
</span><span>
</span><span>    </span><span style=color:#fabd2f>draw_text_mut</span><span>(</span><span style=color:#fe8019>&</span><span style=color:#fa5c4b>mut</span><span> img, </span><span style=color:#fdf4c1>TEXT_COLOR</span><span>, X, Y, </span><span style=color:#fdf4c1>SCALE</span><span>, </span><span style=color:#fabd2f>font</span><span>(), </span><span style=color:#b8bb26>"Hello,"</span><span>);
</span><span>    </span><span style=color:#fa5c4b>let</span><span> y </span><span style=color:#fe8019>=</span><span> Y </span><span style=color:#fe8019>+ </span><span style=color:#fdf4c1>SCALE</span><span>.y </span><span style=color:#fe8019>as </span><span style=color:#fa5c4b>i32</span><span>;
</span><span>    </span><span style=color:#fabd2f>draw_text_mut</span><span>(</span><span style=color:#fe8019>&</span><span style=color:#fa5c4b>mut</span><span> img, </span><span style=color:#fdf4c1>TEXT_COLOR</span><span>, X, y, </span><span style=color:#fdf4c1>SCALE</span><span>, </span><span style=color:#fabd2f>font</span><span>(), </span><span style=color:#fe8019>&</span><span style=color:#fabd2f>format!</span><span>(</span><span style=color:#b8bb26>"</span><span style=color:#fdf4c1>{ip}</span><span style=color:#b8bb26>!"</span><span>));
</span><span>
</span><span>    </span><span style=color:#fa5c4b>let mut</span><span> cursor </span><span style=color:#fe8019>= </span><span>Cursor::new(</span><span style=color:#fabd2f>vec!</span><span>[]);
</span><span>    img.</span><span style=color:#fabd2f>write_to</span><span>(</span><span style=color:#fe8019>&</span><span style=color:#fa5c4b>mut</span><span> cursor, ImageOutputFormat::Png)</span><span style=color:#fe8019>?</span><span>;
</span><span>
</span><span>    </span><span style=color:#fabd2f>Ok</span><span>(([(header::</span><span style=color:#fdf4c1>CONTENT_TYPE</span><span>, </span><span style=color:#b8bb26>"image/png"</span><span>)], cursor.</span><span style=color:#fabd2f>into_inner</span><span>()))
</span><span>}
</span><span>
</span><span>#[</span><span style=color:#fdf4c1>tokio</span><span>::</span><span style=color:#fdf4c1>main</span><span>]
</span><span>async </span><span style=color:#fa5c4b>fn </span><span style=color:#8ec07c>main</span><span>() -> anyhow::</span><span style=color:#fabd2f>Result</span><span><()> {
</span><span>    </span><span style=color:#fa5c4b>let</span><span> app </span><span style=color:#fe8019>= </span><span>Router::new().</span><span style=color:#fabd2f>route</span><span>(</span><span style=color:#b8bb26>"/avatar.png"</span><span>, </span><span style=color:#fabd2f>get</span><span>(avatar));
</span><span>
</span><span>    </span><span style=color:#fa5c4b>let</span><span> listener </span><span style=color:#fe8019>= </span><span>tokio::net::TcpListener::bind(</span><span style=color:#b8bb26>"[::]:3000"</span><span>).await</span><span style=color:#fe8019>?</span><span>;
</span><span>    </span><span style=color:#fa5c4b>let</span><span> make_service </span><span style=color:#fe8019>=</span><span> app.into_make_service_with_connect_info::&LTSocketAddr>();
</span><span>    axum::serve(listener, make_service).await</span><span style=color:#fe8019>?</span><span>;
</span><span>    </span><span style=color:#fabd2f>Ok</span><span>(())
</span><span>}
</span></code></pre><p>Thanks for reading! Maybe I'll learn to write smaller posts next year. 🤣</article></main><footer><nav><a href=/>Home</a> ⬡ <a href=/posts>Posts</a> ⬡ <a href=/tags>Tags</a> ⬡ <a href=/contact>Contact</a></nav><p>© 2024 Ali Ahmadi ⬡ <a href=https://github.com/AliiAhmadi>Github</a></footer>