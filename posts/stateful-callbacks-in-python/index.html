<!doctype html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><title>Stateful Callbacks in Python</title><meta content="Ali Ahmadi" name=author><meta content="Stateful callbacks in Python." name=description><meta content=AliAhmadi2004.ir property=og:site_name><meta content=en-us property=og:locale><meta content=https://AliAhmadi2004.ir/posts/stateful-callbacks-in-python/ property=og:url><meta content="Stateful Callbacks in Python" property=og:title><meta content="Stateful callbacks in Python." property=og:description><meta content=article property=og:type><meta content="Ali Ahmadi" property=og:article:author><meta content=2017-07-10T07:54:00-08:00 property=og:article:published_time><meta content=Posts property=og:article:section><meta content=Python property=og:article:tag><meta content=callbacks property=og:article:tag><link href=https://fonts.googleapis.com/ rel=dns-prefetch><link href=/site.css rel=stylesheet><link rel="shortcut icon" href=/favicon.svg type=image/svg+xml><link href=https://AliAhmadi2004.ir/posts/stateful-callbacks-in-python/ rel=canonical><body><div class=center><img alt=Me src=/self.jpg width=100></div><main><article id=content><header><h1>Stateful Callbacks in Python</h1><div class=post-meta><time datetime=2017-07-10T07:54:00-08:00>2017-07-10</time><span class=accent> ⬡ </span><a href=https://AliAhmadi2004.ir/tags/python/>#Python</a>, <a href=https://AliAhmadi2004.ir/tags/callbacks/>#callbacks</a></div></header><p>If you're unfamiliar with what a callback is, don't worry, we can sort that out quickly. If callbacks are old hat for you you might want to skip to <a href=https://AliAhmadi2004.ir/posts/stateful-callbacks-in-python/#stateful-callbacks>the interesting bit</a>.<p>Simply put, a callback is a function that is passed as an argument to another function which may execute it.</p><span id=continue-reading></span><p>Take, for example, these functions:<pre class=language-python data-lang=python style=background:#282828;color:#fdf4c1aa><code class=language-python data-lang=python><span style=color:#fa5c4b>def </span><span style=color:#8ec07c>bar</span><span>():
</span><span>    </span><span style=color:#fa5c4b>return </span><span style=color:#b8bb26>"I'm the callback!"
</span><span>
</span><span style=color:#fa5c4b>def </span><span style=color:#8ec07c>foo</span><span>(</span><span style=color:#fdf4c1>func</span><span>):
</span><span>    </span><span style=color:#fa5c4b>return </span><span style=color:#fdf4c1>func()
</span></code></pre><p>If we call <code>foo</code> like this<pre class=language-python data-lang=python style=background:#282828;color:#fdf4c1aa><code class=language-python data-lang=python><span style=color:#fe8019>>>> </span><span style=color:#fdf4c1>foo(bar)
</span><span style=color:#b8bb26>"I'm the callback!"
</span></code></pre><p>then <code>bar</code> is a callback.<h2 id=why-should-i-use-a-callback><a aria-label="Anchor link for: why-should-i-use-a-callback" href=#why-should-i-use-a-callback></a>Why Should I Use A Callback?</h2><p>There are many reasons to use callbacks. For me, the most compelling is customization. Let's take a look at a Python built-in as an example. Say we have a list of users as dictionaries with a <code>name</code> and an <code>age</code>:<pre class=language-python data-lang=python style=background:#282828;color:#fdf4c1aa><code class=language-python data-lang=python><span>users </span><span style=color:#fe8019>= </span><span>[
</span><span>    </span><span style=color:#fabd2f>dict</span><span style=color:#fdf4c1>(age</span><span style=color:#fe8019>=</span><span style=color:#d3869b>77</span><span style=color:#fdf4c1>, name</span><span style=color:#fe8019>=</span><span style=color:#b8bb26>'John Cleese'</span><span style=color:#fdf4c1>)</span><span>,
</span><span>    </span><span style=color:#fabd2f>dict</span><span style=color:#fdf4c1>(age</span><span style=color:#fe8019>=</span><span style=color:#d3869b>74</span><span style=color:#fdf4c1>, name</span><span style=color:#fe8019>=</span><span style=color:#b8bb26>'Eric Idle'</span><span style=color:#fdf4c1>)</span><span>,
</span><span>]
</span></code></pre><p>Imagine that we want to sort our users. If we had just a list of ages or a list of names we could easily do this with the built-in <code>sorted</code> function, but by default Python has no idea how to compare our dictionaries during sorting.<pre class=language-python data-lang=python style=background:#282828;color:#fdf4c1aa><code class=language-python data-lang=python><span style=color:#fe8019>>>> </span><span style=color:#fabd2f>sorted</span><span style=color:#fdf4c1>(users)
</span><span style=color:#fdf4c1>Traceback (most recent call last)</span><span>:
</span><span>  File </span><span style=color:#b8bb26>"&LTstdin>"</span><span>, line </span><span style=color:#d3869b>1</span><span>, </span><span style=color:#fe8019>in <</span><span>module</span><span style=color:#fe8019>>
</span><span style=color:#fabd2f>TypeError</span><span>: unorderable types: </span><span style=color:#fabd2f>dict</span><span style=color:#fdf4c1>() </span><span style=color:#fe8019>< </span><span style=color:#fabd2f>dict</span><span style=color:#fdf4c1>()
</span></code></pre><p>Should it sort by <code>age</code>? By <code>name</code>? We need to tell Python how this should be done. Fortunately Python provides and the <code>sorted</code> function has a keyword argument called <code>key</code> that takes, you guessed it, a callback. Let's create some of our own!<pre class=language-python data-lang=python style=background:#282828;color:#fdf4c1aa><code class=language-python data-lang=python><span style=color:#fa5c4b>def </span><span style=color:#8ec07c>by_age</span><span>(</span><span style=color:#fdf4c1>user</span><span>):
</span><span>    </span><span style=color:#fa5c4b>return </span><span>user[</span><span style=color:#b8bb26>'age'</span><span>]
</span><span>
</span><span style=color:#fa5c4b>def </span><span style=color:#8ec07c>by_name</span><span>(</span><span style=color:#fdf4c1>user</span><span>):
</span><span>    </span><span style=color:#fa5c4b>return </span><span>user[</span><span style=color:#b8bb26>'name'</span><span>]
</span></code></pre><p>Armed with these callbacks we can sort our users.<pre class=language-python data-lang=python style=background:#282828;color:#fdf4c1aa><code class=language-python data-lang=python><span style=color:#fe8019>>>> </span><span style=color:#fabd2f>sorted</span><span style=color:#fdf4c1>(users, key</span><span style=color:#fe8019>=</span><span style=color:#fdf4c1>by_age)
</span><span>[{</span><span style=color:#b8bb26>'age'</span><span>: </span><span style=color:#d3869b>74</span><span>, </span><span style=color:#b8bb26>'name'</span><span>: </span><span style=color:#b8bb26>'Michael Palin'</span><span>}, {</span><span style=color:#b8bb26>'age'</span><span>: </span><span style=color:#d3869b>77</span><span>, </span><span style=color:#b8bb26>'name'</span><span>: </span><span style=color:#b8bb26>'John Cleese'</span><span>}]
</span><span style=color:#fe8019>>>> </span><span style=color:#fabd2f>sorted</span><span style=color:#fdf4c1>(users, key</span><span style=color:#fe8019>=</span><span style=color:#fdf4c1>by_name)
</span><span>[{</span><span style=color:#b8bb26>'age'</span><span>: </span><span style=color:#d3869b>77</span><span>, </span><span style=color:#b8bb26>'name'</span><span>: </span><span style=color:#b8bb26>'John Cleese'</span><span>}, {</span><span style=color:#b8bb26>'age'</span><span>: </span><span style=color:#d3869b>74</span><span>, </span><span style=color:#b8bb26>'name'</span><span>: </span><span style=color:#b8bb26>'Michael Palin'</span><span>}]
</span></code></pre><p>Since the <code>sorted</code> function takes a callback for the <code>key</code> argument we are free to customize its behavior. All we have to do is define a function that returns the key we intend to sort by and as long as that's an orderable type Python will take care of the rest.<h2 id=what-does-it-mean-to-have-state><a aria-label="Anchor link for: what-does-it-mean-to-have-state" href=#what-does-it-mean-to-have-state></a>What Does It Mean to Have State?</h2><p>So, by now we have something of an idea of what callbacks are, how we can use them, and why, but what's the point of state? State is most easily described as a memory of prior events. This is the core of what every program does and we use it all the time, even if we don't realize it. Heck, even saving a variable involves keeping track of state.<pre class=language-python data-lang=python style=background:#282828;color:#fdf4c1aa><code class=language-python data-lang=python><span style=color:#fe8019>>>> </span><span>baz </span><span style=color:#fe8019>= </span><span style=color:#d3869b>1  </span><span style=font-style:italic;color:#928374># The Python interpreter is now tracking the state of 'baz'.
</span><span style=color:#fe8019>>>> </span><span style=color:#fabd2f>print</span><span style=color:#fdf4c1>(baz)  </span><span style=font-style:italic;color:#928374># We can recall that state at a later point.
</span><span style=color:#d3869b>1
</span></code></pre><p>Basically, we need state if we care to remember what happened previously so that we can make decisions about what to do next.<h2 id=what-normally-happens-to-state-inside-a-callback><a aria-label="Anchor link for: what-normally-happens-to-state-inside-a-callback" href=#what-normally-happens-to-state-inside-a-callback></a>What Normally Happens to State Inside a Callback?</h2><p>In our first callback function we didn't define any names. To demonstrate what typically happens to state inside the scope of a callback let's make a function that creates some state.<pre class=language-python data-lang=python style=background:#282828;color:#fdf4c1aa><code class=language-python data-lang=python><span style=color:#fa5c4b>def </span><span style=color:#8ec07c>quux</span><span>():
</span><span>    plugh </span><span style=color:#fe8019>= </span><span style=color:#b8bb26>"xyzzy"
</span><span>    </span><span style=color:#fa5c4b>return </span><span>plugh
</span></code></pre><p>When we execute this function we get the expected result.<pre class=language-python data-lang=python style=background:#282828;color:#fdf4c1aa><code class=language-python data-lang=python><span style=color:#fe8019>>>> </span><span style=color:#fdf4c1>quux()
</span><span style=color:#b8bb26>'xyzzy'
</span></code></pre><p>After the function is executed we can see that the <code>plugh</code> name is not defined.<pre class=language-python data-lang=python style=background:#282828;color:#fdf4c1aa><code class=language-python data-lang=python><span style=color:#fe8019>>>> </span><span>plugh
</span><span style=color:#fdf4c1>Traceback (most recent call last)</span><span>:
</span><span>  File </span><span style=color:#b8bb26>"&LTstdin>"</span><span>, line </span><span style=color:#d3869b>1</span><span>, </span><span style=color:#fe8019>in <</span><span>module</span><span style=color:#fe8019>>
</span><span style=color:#fabd2f>NameError</span><span>: name </span><span style=color:#b8bb26>'plugh' </span><span style=color:#fe8019>is not </span><span>defined
</span></code></pre><p>This is because when the function is finished executing its frame is removed from the <a href=https://en.wikipedia.org/wiki/Call_stack>call stack</a> along with any locally defined variables. By itself our callback can't remember anything.<h2 id=stateful-callbacks><a aria-label="Anchor link for: stateful-callbacks" href=#stateful-callbacks></a>Stateful Callbacks</h2><p>Alright, so we know what callbacks are, we know what state is. How can we combine the two to make a callback that retains its state? As we saw above we can't rely on any state that we define inside our callback. The trick to making a stateful callback is to rely on names bound to an external scope.<p>To motivate creating a stateful callback let's say that we still want to sort users like we did above, only now we have 1 Million users. It's going to take a while to sort those users, so it would be nice to have a progress report so we know something is still happening, maybe once per 10,000 users.<h3 id=using-functions><a aria-label="Anchor link for: using-functions" href=#using-functions></a>Using Functions</h3><p>To use names bound to an external scope with a plain ol' function as our callback we'll need to take advantage of <a href=https://en.wikipedia.org/wiki/Closure_(computer_programming)>closures</a> (which could be an entirely separate post). Here's a function that allows us to use our original <code>by_age</code> and <code>by_name</code> sorters while still giving us progress.<pre class=language-python data-lang=python style=background:#282828;color:#fdf4c1aa><code class=language-python data-lang=python><span style=color:#fa5c4b>def </span><span style=color:#8ec07c>sort_reporter</span><span>(</span><span style=color:#fdf4c1>func</span><span>):
</span><span>    state </span><span style=color:#fe8019>= </span><span style=color:#fabd2f>dict</span><span style=color:#fdf4c1>(count</span><span style=color:#fe8019>=</span><span style=color:#d3869b>0</span><span style=color:#fdf4c1>)  </span><span style=font-style:italic;color:#928374># We can't just call this 'count'...
</span><span>
</span><span>    </span><span style=color:#fa5c4b>def </span><span style=color:#8ec07c>_sort_reporter</span><span>(</span><span style=color:#fdf4c1>user</span><span>):
</span><span>        state[</span><span style=color:#b8bb26>'count'</span><span>] </span><span style=color:#fe8019>+= </span><span style=color:#d3869b>1  </span><span style=font-style:italic;color:#928374># Because we'd get an UnboundLocalError here.
</span><span>        </span><span style=color:#fa5c4b>if </span><span>state[</span><span style=color:#b8bb26>'count'</span><span>] </span><span style=color:#fe8019>% </span><span style=color:#d3869b>10000 </span><span style=color:#fe8019>== </span><span style=color:#d3869b>0</span><span>:
</span><span>            </span><span style=color:#fabd2f>print</span><span style=color:#fdf4c1>(</span><span style=color:#b8bb26>"Sorted </span><span style=color:#fdf4c1>{count}</span><span style=color:#b8bb26> users."</span><span style=color:#fdf4c1>.format(count</span><span style=color:#fe8019>=</span><span style=color:#fdf4c1>state[</span><span style=color:#b8bb26>'count'</span><span style=color:#fdf4c1>]))
</span><span>        </span><span style=color:#fa5c4b>return </span><span style=color:#fdf4c1>func(user)
</span><span>
</span><span>    </span><span style=color:#fa5c4b>return </span><span>_sort_reporter
</span></code></pre><p>We can use it like so.<pre class=language-python data-lang=python style=background:#282828;color:#fdf4c1aa><code class=language-python data-lang=python><span style=color:#fe8019>>>> </span><span>sorted_users </span><span style=color:#fe8019>= </span><span style=color:#fabd2f>sorted</span><span style=color:#fdf4c1>(users, key</span><span style=color:#fe8019>=</span><span style=color:#fdf4c1>sort_reporter(by_name))
</span><span>Sorted </span><span style=color:#d3869b>10000 </span><span>users.
</span><span>Sorted </span><span style=color:#d3869b>20000 </span><span>users.
</span><span style=font-style:italic;color:#928374># Lots more of this...
</span></code></pre><p>How does it work? The key is the <code>state</code> dictionary. It lets us keep a mutable reference to a name defined outside the scope of the actual reporter function, <code>_sort_reporter</code>. As the <code>sorted</code> built-in is processing our <code>users</code> each new call to <code>_sort_reporter</code> still gets to refer to the original <code>state</code>.<p><small><b>Note</b>: We could avoid having a <code>state</code> dictionary by using Python 3's <code>nonlocal</code> keyword, but then I'd miss an opportunity in the <a href=https://AliAhmadi2004.ir/posts/stateful-callbacks-in-python/#bonus>bonus</a> section.</small><h3 id=using-classes><a aria-label="Anchor link for: using-classes" href=#using-classes></a>Using Classes</h3><p>If the functional approach doesn't suit you we can also tackle this problem from an object-oriented angle. Python lets classes define a <a href=https://docs.python.org/3/reference/datamodel.html#object.__call__><code>__call__</code> method</a> which makes them callable. This isn't strictly necessary for an OOP approach, but when we're making callbacks it's nice to be able to treat our instances as functions.<pre class=language-python data-lang=python style=background:#282828;color:#fdf4c1aa><code class=language-python data-lang=python><span style=color:#fa5c4b>class </span><span style=color:#8ec07c>SortReporter</span><span>:
</span><span>    </span><span style=color:#fa5c4b>def </span><span style=color:#fabd2f>__init__</span><span>(</span><span style=color:#fdf4c1>self</span><span>, </span><span style=color:#fdf4c1>func</span><span>):
</span><span>        </span><span style=color:#fdf4c1>self</span><span>.func </span><span style=color:#fe8019>= </span><span>func
</span><span>        </span><span style=color:#fdf4c1>self</span><span>.count </span><span style=color:#fe8019>= </span><span style=color:#d3869b>0
</span><span>
</span><span>    </span><span style=color:#fa5c4b>def </span><span style=color:#fabd2f>__call__</span><span>(</span><span style=color:#fdf4c1>self</span><span>, </span><span style=color:#fdf4c1>user</span><span>):
</span><span>        </span><span style=color:#fdf4c1>self</span><span>.count </span><span style=color:#fe8019>+= </span><span style=color:#d3869b>1
</span><span>        </span><span style=color:#fa5c4b>if </span><span style=color:#fdf4c1>self</span><span>.count </span><span style=color:#fe8019>% </span><span style=color:#d3869b>10000 </span><span style=color:#fe8019>== </span><span style=color:#d3869b>0</span><span>:
</span><span>            </span><span style=color:#fabd2f>print</span><span style=color:#fdf4c1>(</span><span style=color:#b8bb26>"Sorted </span><span style=color:#fdf4c1>{count}</span><span style=color:#b8bb26> users."</span><span style=color:#fdf4c1>.format(count</span><span style=color:#fe8019>=</span><span style=color:#fdf4c1>self.count))
</span><span>        </span><span style=color:#fa5c4b>return </span><span style=color:#fdf4c1>self.func(user)
</span></code></pre><p>Just as easy to use as our functional option.<pre class=language-python data-lang=python style=background:#282828;color:#fdf4c1aa><code class=language-python data-lang=python><span style=color:#fe8019>>>> </span><span>sorted_users </span><span style=color:#fe8019>= </span><span style=color:#fabd2f>sorted</span><span style=color:#fdf4c1>(users, key</span><span style=color:#fe8019>=</span><span style=color:#fdf4c1>SortReporter(by_age))
</span><span>Sorted </span><span style=color:#d3869b>10000 </span><span>users.
</span><span>Sorted </span><span style=color:#d3869b>20000 </span><span>users.
</span><span style=font-style:italic;color:#928374># One eternity later...
</span></code></pre><p>Conceptually, this works for much the same reason that the functional approach does. The <code>SortReporter</code> instance and all its associated state lives on because the <code>sorted</code> built-in is carrying around a reference to it and it just pretends to be a plain ol' function whenever <code>sorted</code> needs it to be one.<h3 id=which-should-i-use><a aria-label="Anchor link for: which-should-i-use" href=#which-should-i-use></a>Which Should I Use?</h3><p>Neither approach is any more or less valid than the other. For this particular example there isn't much more code or complexity either way. I generally regard functions as being simpler than classes, so I prefer those when possible, but classes also provide good structure for more complex callbacks. Try them both!<h4 id=bonus><a aria-label="Anchor link for: bonus" href=#bonus></a>Bonus</h4><p>As <s>homework</s> a bonus, try instantiating a <code>SortReporter</code> and examining its <code>__dict__</code> attribute. Meditate on what you find there and how it relates to the <code>state</code> dictionary in the functional approach.<p>If you get really bold and want to try for extra credit assign the return value of the <code>sort_reporter</code> function to some variable and examine its <code>__closure__</code> attribute. This may help you explain why the <code>state</code> dictionary doesn't disappear after the <code>sort_reporter</code> function is called.</article></main><footer><nav><a href=/>Home</a> ⬡ <a href=/posts>Posts</a> ⬡ <a href=/tags>Tags</a> ⬡ <a href=/contact>Contact</a></nav><p>© 2024 Ali Ahmadi ⬡ <a href=https://github.com/AliiAhmadi>Github</a></footer>